<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="书籍,MySQL," />





  <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml" />






<meta name="description" content="二十二、使用视图1、视图是什么？（注：MySQL 5添加了对视图的支持，因此，使用视图需要版本在MySQL 5及以后的版本。）视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。例如：　　SELECT cust_name,cust_contact FROM customers,orders,orderitems WHERE customers.cust_id = orders">
<meta name="keywords" content="书籍,MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="《MySQL必知必会》-高级知识">
<meta property="og:url" content="http://yoursite.com/2017/12/07/MySQL 《必知必会》-高级知识/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="二十二、使用视图1、视图是什么？（注：MySQL 5添加了对视图的支持，因此，使用视图需要版本在MySQL 5及以后的版本。）视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。例如：　　SELECT cust_name,cust_contact FROM customers,orders,orderitems WHERE customers.cust_id = orders">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-21T10:22:41.689Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《MySQL必知必会》-高级知识">
<meta name="twitter:description" content="二十二、使用视图1、视图是什么？（注：MySQL 5添加了对视图的支持，因此，使用视图需要版本在MySQL 5及以后的版本。）视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。例如：　　SELECT cust_name,cust_contact FROM customers,orders,orderitems WHERE customers.cust_id = orders">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/12/07/MySQL 《必知必会》-高级知识/"/>





  <title>《MySQL必知必会》-高级知识 | Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9c4b2184b7b2f90dbd8b8e34c44e11eb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/07/MySQL 《必知必会》-高级知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zheng Benwu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/IMG_2796.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">《MySQL必知必会》-高级知识</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-07T13:09:00+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/书籍/" itemprop="url" rel="index">
                    <span itemprop="name">书籍</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/12/07/MySQL 《必知必会》-高级知识/" class="leancloud_visitors" data-flag-title="《MySQL必知必会》-高级知识">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="二十二、使用视图"><a href="#二十二、使用视图" class="headerlink" title="二十二、使用视图"></a>二十二、使用视图</h2><p>1、视图是什么？<br><em>（注：MySQL 5添加了对视图的支持，因此，使用视图需要版本在MySQL 5及以后的版本。）</em><br>视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。<br>例如：<br>　　<code>SELECT cust_name,cust_contact FROM customers,orders,orderitems WHERE customers.cust_id = orders.cust_id AND orderitems.order_num = oders.order_num AND prod_id = &#39;TNT2&#39;;</code><br>此查询用来检索订购了某个特定产品的用户。<br>假如可以把整个查询包装成一个名为productcustomers的虚拟表，则可以如下轻松地检索出相同的数据：<br>　　<code>SELECT cust_name,cust_contact FROM productcustomers WERE prod_id = &#39;TNT2&#39;;</code><br>这就是视图的作用。productcustomers是一个试图，作为视图，它不包含表中应该有的任何列或数据，它包含的是一个SQL查询（与上面用以正确联结表的相同的查询）。<br><a id="more"></a><br>1.2、为什么使用视图？<br>下面是视图的一些常见应用：</p>
<pre><code>1. 重用SQL语句
2. 简化复杂的SQL操作。在编写查询后，可以方便地重用它而不必知道它的基本查询细节。
3. 使用表的组成部分而不是整个表。
4. 保护数据。可以给用户授予表的特定部分的访问权限而不是整个表的访问权限。
5. 更改数据格式和标识。视图可返回与底层表的表示和格式不同的数据。
</code></pre><p>　　在视图创建之后，可以用与表基本相同的方式利用它们。可以对视图执行SELECT操作，过滤和排序数据，将视图联结到其他视图或表，甚至能添加和更新数据（添加和更新数据存在某些限制。）。<br>　　需要知道的是：视图仅仅是用来查看存储在别处的数据的一种设施。视图本身不包含数据，因此它们返回的数据是从其他表中检索出来的。在添加或更改这些表中的数据时，视图将返回改变过的数据。<br><em>（性能问题：因为视图不包含数据，所以每次使用视图时，都必须处理查询执行时所需的任一个检索。如果你用多个联结和过滤创建了复杂的视图或者嵌套了视图，可能会发现性能下降得很厉害。因此，在部署使用了大量视图的应用前，应该进行测试。）</em></p>
<p>1.3、视图的规则和限制<br>下面是关于视图创建和使用的一些最常见的规则和限制：</p>
<pre><code>1. 与表一样，视图必须唯一命名（不能给视图取与别的视图或者表相同的名字）。
2. 对于可以创建的视图数目没有限制。
3. 为了创建视图，必须具有足够的访问权限。这些限制通常由数据库管理人员授予。
4. 视图可以嵌套，既可以利用从其它视图中检索数据的查询来构造一个试图。
5. ORDER BY可以用在视图中，但如果从该视图检索数据SELECT中也含有ORDER BY，那么该视图中的ORDER BY将被覆盖。
6. 视图不能索引，也不能有关联的触发器或默认值。
7. 视图可以和表一起使用。例如，编写一条联结表和视图的SELECT语句。
</code></pre><p>2、视图是怎样工作的？<br>　2.1视图的创建：</p>
<pre><code>1. 视图用CREATE VIEW语句来创建。
2. 使用SHOW CREATE VIEW viewname;来查看创建视图的语句。
3. 用DROP删除视图，其语法为DROP VIEW viewname;。
4. 更新视图时，可以先用DROP再用CREATE，也可以直接用CREATE OR REPLACE VIEW。
</code></pre><p>　如果要更新的视图不存在，则第2条更新语句会创建一个试图；如果更新的视图存在，则第2条更新语句会替换原有视图。<br>　2.2 常用的视图应用</p>
<pre><code>1. 隐藏复杂的SQL，这通常都会涉及联结。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW productcustomers AS </span><br><span class="line">SELECT cust_name,cust_contact,prod_id </span><br><span class="line">FROM customers,orders,orderitems</span><br><span class="line">WHERE customers.cust_id = orders.cust_id </span><br><span class="line">  AND orderitems.order_num = orders.order_num;</span><br></pre></td></tr></table></figure>

这条语句创建一个名为productcustomers的视图，联结了3个表，以返回已订购了任意产品的所有客户的列表。
为检索订购了产品的TNT2的客户，可如下进行：
　`SELECT cust_name,cust_contact FROM productcustomers WHERE prod_id=&apos;TNT2&apos;;`
（注：创建可重用的视图：创建不受特定数据限制的视图是一种好办法。）

2. 用视图重新格式化检索出的数据。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT Concat(RTrim(vend_name), &apos;(&apos;, RTrim(vend_country), &apos;)&apos;) </span><br><span class="line">       AS vend_title </span><br><span class="line">FROM vendors ORDER BY vend_name;</span><br></pre></td></tr></table></figure>

假如经常需要这个格式的结果，可创建一个试图，每次需要时使用它。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW vendorlocations AS</span><br><span class="line">SELECT Concat(RTrim(vend_name), &apos;(&apos;, RTrim(vend_country), &apos;)&apos;)</span><br><span class="line">       AS vend_title</span><br><span class="line">FROM vendors ORDER BY vend_name;</span><br></pre></td></tr></table></figure>

3. 用视图过滤不想要的数据
视图对于应用普通的WHERE子句也很有用。例如，可以定义customeremaillist视图，它过滤没有电子邮件地址的客户。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW customeremaillist </span><br><span class="line">SELECT cust_id,cust_name,cust_email FROM customers </span><br><span class="line">WHERE cust_email IS NOT NULL;</span><br></pre></td></tr></table></figure>

（注：WHERE子句与WHERE子句：如果从视图检索数据时使用了一条WHERE子句，则两组子句（一组在视图中，另一组是传递给视图的）将自动组合。）

4. 使用视图与计算字段
视图对于简化计算字段的使用特别有用。下面是它检索某个特定订单中的物品，计算每种物品的总价格：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW orderitemsexpanded AS </span><br><span class="line">SELECT order_num,prod_id,quantity,item_price,</span><br><span class="line">       quantity*item_price AS expanded_price </span><br><span class="line">FROM orderitems;</span><br></pre></td></tr></table></figure>

为检索订单20005的详细内容可如下操作：
`SELECT * FROM orderitemsexpanded WHERE order_num = 20005;`
</code></pre><p>　2.3 更新视图<br>　通常，视图是可更新的（即可以对它们使用INSERT、UPDATE和DELETE）。更新一个视图将更新其基表（可以回忆一下，视图本身没有数据）。<br>　但是，并非所有视图都是可更新的。基本上如果MySQL不能正确地确定被更新的基数据，则不允许更新（包括插入和删除）。这实际上意味着，如果视图定义中有以下操作，则不能进行视图的更新：</p>
<pre><code>1. 分组（使用GROUP BY和HAVING）
2. 联结
3. 子查询
4. 并
5. 聚集涵涵素（Min()、Count()、Sum()等）
6. DISTINCT
7. 导出（计算）列。
因此，一般应该将视图用于检索（SELECT语句）而不用于更新（INSERT、UPDATE和DELETE）。
</code></pre><h2 id="二十三、使用存储过程"><a href="#二十三、使用存储过程" class="headerlink" title="二十三、使用存储过程"></a>二十三、使用存储过程</h2><p>1、什么是存储过程？<br><em>（注：MySQL 5添加了对存储过程的支持，因此需要MySQL 5及以后的版本。）</em><br>　迄今为止，使用的大多数SQL语句都是针对一个或多个表的单条语句。并非所有操作都这么简单，经常会有一个完整的操作需要多条语句才能完成。例如下面的情形：</p>
<pre><code>1. 为了处理订单，需要核对以保证库存中有相应的物品。
2. 如果库存有物品，这些物品需要预定以便不将它们再卖给别人，并且要减少可用的物品数量以反映正确的库存量。
3. 库存中没有的物品需要订购，这需要与供应商进行某种交互。
4. 关于哪些物品入库（并且可以立即发货）和哪些物品退订，需要通知相应的客户。
</code></pre><p>　这显然不是一个完整的例子，执行这个处理需要针对许多表的多条MySQL语句。此外，需要执行的具体语句及其次序也不是固定的，它们可能会（和将）根据哪些物品在库存中哪些不在而变化。<br>　可以创建存储过程。存储过程简单来说，就是为以后的使用而保存的一条或多条MySQL语句的集合。可将其视为批文件，虽然它们的作用不仅限于批处理。</p>
<p>2、为什么要使用存储过程？<br>　下面列出一些主要的理由：</p>
<pre><code>1. 通过把处理封装在容易使用的单元中，简化复杂的操作。
2. 由于不要求反复建立一系列处理步骤，这保证了数据的完整性。如果所有开发人员和应用程序都使用同一（试验和测试）存储过程，则所使用的代码都是相同的。
    这一点的延伸就是防止错误。需要执行的步骤越多，出错的可能性就越大。防止错误保证了数据的一致性。
3. 简化对变动的管理。如果表名、列名或业务逻辑（或别的内容）有变化，只需要更改存储过程的代码。使用它的人员甚至不需要知道这些变化。
    这一点的延伸就是安全性。通过存储过程限制对基础数据的访问减少了数据讹误（无意识的或别的原因所导致的数据讹误）的机会。
4. 提高性能。因为使用存储过程比使用单独的SQL语句更快。
5. 存在一些只能用在单个请求中的MySQL元素和特性，存储过程以使用它们来编写功能更强更灵活的代码。
</code></pre><p>　换句话说，使用存储过程有3个主要的好处，即简单、安全、高性能。<br>　不过，在将SQL代码转换为存储过程前，也必须知道它的一些缺陷：</p>
<pre><code>1. 一般来说，存储过程的编写比基本的SQL语句复杂，编写存储过程需要更高的技能，更丰富的经验
2. 你可能没有创建存储过程的安全访问权限。许多数据库管理员限制存储过程的创建权限，允许用户使用存储过程，但不允许他们创建存储过程。
</code></pre><p>3、如何使用存储过程？<br>　存储过程的执行远比其定义更经常遇到，因此，我们将从执行存储过程开始介绍。然后再介绍创建和使用存储过程。<br>　3.1 执行存储过程<br>　MySQL称存储过程的执行为调用，因此MySQL执行存储过程的语句为CALL。CALL接受存储过程的名字以及需要传递给它的任意参数。<br>　例如：<br>    <figure class="highlight plain"><figcaption><span>productpricing(@pricelow,</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@pricehigh,</span><br><span class="line">@priceaverage);</span><br></pre></td></tr></table></figure></p>
<p>　其中，执行名为productpricing的存储过程，它计算并返回产品的最低、最高和平均价格。<br>　3.2 创建存储过程<br>　例子：一个返回产品平均价格的存储过程：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE productpricing()</span><br><span class="line">BEGIN</span><br><span class="line">    SELECT Avg(prod_price) AS priceaverage FROM products;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　此存储过程名为productpricing，用CREATE PROCUDURE productpricing()语句定义。<br>　如果存储过程接受参数，它们将在()中列举出来。此存储过程没有参数，但后跟的()仍然需要。BEGIN和END语句用来限定存储过程体，过程体本身仅是一个简单的SELECT语句。<br>　在MySQL处理这段代码时，它创建一个新的存储过程productpricing。没有返回数据，因为这段代码并未调用存储过程，这里只是为以后使用而创建它。</p>
<p>　（注：mysql命令行客户机的分隔符，如果你使用的是mysql命令行实用程序，请往下看：默认的MySQL语句分隔符;（正如你已经在迄今为止所使用的MySQL语句中所看到的那样）。mysql命令行实用程序也使用;作为语句分隔符。如果命令行使用程序要解释存储过程自身内的;字符，则它们最终不会成为存储过程的成分，这会使存储过程中的SQL出现句法错误。解决办法是临时更改命令行使用程序的语句分隔符，如下所示：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE productpricing()</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT Avg(prod_price) AS priceaverage FROM products;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>DELIMITER //</code> 告诉命令行实用程序使用//作为新的语句结束分隔符，可以看到标志存储过程结束的END定义为END//而不是END;。这样，存储过程体内的;仍然保持不动，并且正确地传递给数据库引擎。最后，为恢复为原来的语句分隔符，可使用DELIMITER ;。除\符号外，任何字符都可以用作语句分隔符。如果你使用的是mysql命令行实用程序，在阅读本章时请记住这里的内容。）</p>
<p>　3.3 使用存储过程<br>　　<code>CALL productpricing();</code><br>　执行刚创建的存储过程并显示返回的结果。因为存储过程实际上是一种函数，所以存储过程名后需要有()符号（即使不传递参数也需要）。</p>
<p>　3.4 删除存储过程<br>　　<code>DROP PROCEDURE productpricing;</code><br>　请注意没有使用后面的()，只给出存储过程名。<br>　<em>（注：如果指定的过程不存在，则DROP PROCEDURE将产生一个错误。当过程存在想删除它时（如果过程不存在也不产生错误）可使用DROP PROCEDURE IF EXISTS。）</em></p>
<p>　3.4 使用参数<br>　以下是productpricing的修改版本(如果不先删除此存储过程，则不能再次创建它)：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE productpricing(</span><br><span class="line">    OUT pl DECIMAL(8, 2),</span><br><span class="line">    OUT ph DECIMAL(8, 2),</span><br><span class="line">    OUT pa DECIMAL(8, 2)</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">    SELECT Min(prod_price) INTO pl FROM products;</span><br><span class="line">    SELECT Max(prod_price) INTO ph FROM products;</span><br><span class="line">    SELECT Avg(prod_price) INTO pa FROM products;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　此存储过程接受3个参数：pl存储产品的最低价格，ph存储产品的最高价格，pa存储产品的平均价格。每个参数必须具有指定的类型，这里使用十进制值。<br>　关键字OUT指出相应的参数用来从存储过程传出一个值（返回给调用者）。<br>　MySQL支持IN（传递给存储过程）、OUT（从存储过程传出）和INOUT（对存储过程传入和传出）类型的参数。<br>　<em>（注：存储过程的参数允许的数据类型与表中使用的数据类型相同。）</em><br>　调用此修改过的存储过程，必须指定3个变量名。<br>　　<code>CALL productpricing(@pricelow, @pricehigh, @priceaverage);</code><br>　<em>（注：所有MySQL变量都必须以@开始。）</em><br>　为了显示检索出的值，可以使用以下语句：<br>　　<code>SELECT @pricehigh, @pricelow, @priceaverage;</code></p>
<p>　3.5 建立智能存储过程<br>　只有在存储过程内包含业务规则和智能处理时，它们的威力才真正显现出来。<br>　考虑这个场景。你需要获得与以前一样的订单合计，但需要对合计增加营业税，不过只针对某些顾客。那么，你需要做下面几件事情：</p>
<pre><code>1. 获得合计（与以前一样）；
2. 把营业税有条件地添加到合计；
3. 返回合计（带或不带税）。
</code></pre><p>　存储过程的完整工作如下：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">-- Name: ordertotal</span><br><span class="line">-- Parameters: onumber = order number</span><br><span class="line">--             taxable = 0 if not taxable,1 if taxable</span><br><span class="line">--             ototal  = order total variable</span><br><span class="line">CREATE PROCEDURE ordertotal(</span><br><span class="line">    IN onumber INT,</span><br><span class="line">    IN taxable BOOLEAN,</span><br><span class="line">    OUT ototal DECIMAL(8,2)</span><br><span class="line">) COMMENT &apos;Obtain order total, optionally adding tax&apos;</span><br><span class="line">BEGIN</span><br><span class="line">    -- Declare variable for total</span><br><span class="line">    DECLARE total DECIMAL(8,2);</span><br><span class="line">    -- Declare tax percentage</span><br><span class="line">    DECLARE taxrate INT DEFAULT 6;</span><br><span class="line"></span><br><span class="line">    -- Get the order total</span><br><span class="line">    SELECT Sum(item_price*quantity) FROM orderitems</span><br><span class="line">    WHERE order_num = onumber</span><br><span class="line">    INTO total;</span><br><span class="line"></span><br><span class="line">    -- Is this taxable?</span><br><span class="line">    IF taxable THEN</span><br><span class="line">        -- Yes, so add taxrate to the total</span><br><span class="line">        SELECT total+(total/100*taxrate) INTO total;</span><br><span class="line">    END IF;</span><br><span class="line">  </span><br><span class="line">    -- AND finally, save to out variable</span><br><span class="line">    SELECT total INTO ototal;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　此存储过程有很大的变动。首先，增加了注释（前面放置–）。添加了另外一个参数taxable，它是一个布尔值。在存储过程体中，用DECLARE语句定义了两个局部变量。DECLARE要求指定变量名和数据类型，它也支持可选的默认值（这个例子中的taxable的默认值被设置为6%）。SELECT语句已经改变，因此其结果存储到total（局部变量）而不ototal。IF语句检查taxable是否为真，如果为真，则用另一SELECT语句增加营业税到局部变量total。最后，用另一SELECT语句将total（它增加或许不增加营业税）保存到ototal。<br>　<em>（注：COMMENT关键字：它不是必需的，但如果给出，将在SHOW PROCEDURE STATUS的结果中显示。）</em><br>　<em>（注：IF语句：IF语句还支持ELSEIF和ELSE子句（前者还使用THEN子句，后者不使用）。）</em></p>
<p>　3.6 检查存储过程<br>　为显示用来创建一个存储过程的CREATE语句，使用SHOW CREATE PROCEDURE语句：<br>　　<code>SHOW CREATE PROCEDURE ordertotal;</code><br>　为了获得包括何时、由谁创建等详细信息的存储过程列表，使用SHOW PROCUDURE STATUS语句：<br>　　<code>SHOW PROCEDURE STATUS LIKE &#39;ordertotal&#39;;</code><br>　<em>（注：SHOW PROCEDURE STATUS列出所有存储过程，为了限制其输出，可使用LIKE指定一个过滤模式。）</em></p>
<h2 id="二十四、使用游标"><a href="#二十四、使用游标" class="headerlink" title="二十四、使用游标"></a>二十四、使用游标</h2><p>1、什么是游标？<br><em>（注：MySQL 5添加了对游标的支持）</em><br>　使用简单的SELECT语句，没有办法得到第一行、下一行或前10行，也不存在每次一行地处理所有行的简单方法。有时，需要在检索出来的行中前进或后退一行或多行。这就是使用游标的原因。<br>　游标（cursor）是一个存储在MySQL服务器上的数据库查询，它不是一条SELECT语句，而是被该语句检索出来的结果集。在存储了游标之后，应用程序可以根据需要滚动或浏览其中的数据。<br>　游标主要用于交互式应用，其中用户需要滚动屏幕上的数据，并对数据进行浏览或做出更改。<br><em>（注：MySQL游标只能用于存储过程（和函数）。）</em></p>
<p>2、如何使用游标？<br>　2.1使用游标涉及几个明确的步骤：</p>
<pre><code>1. 在能够使用游标前，必须声明（定义）它。这个过程实际上没有检索数据，它只是定义要使用的SELECT语句。
2. 一旦声明后，必须打开游标以供使用。这个过程用前面定义的SELECT语句把数据实际检索出来。
3. 对于填有数据的游标，根据需要取出（检索）各行。
4. 在结束游标使用时，必须关闭游标。
</code></pre><p>　2.2 创建游标<br>　游标用DECLARE语句创建。DECLARE命名游标，并定义相应的SELECT语句，根据需要带WHERE和其它子句。<br>　例如：下面语句定义了名为ordernumbers的游标：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE processorders()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE ordernumbers CURSOR</span><br><span class="line">    FOR</span><br><span class="line">    SELECT order_num FROM orders;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　2.3 打开和关闭游标<br>　在定义游标之后，可以打开它。<br>　游标用OPEN CURSOR语句来打开：<br>　　<code>OPEN ordernumbers;</code><br>　游标处理完成后，应当使用如下语句关闭游标：<br>　　<code>CLOSE ordernumbers;</code><br>　在一个游标关闭后，如果没有重新打开，则不能使用它。但是，使用声明过的游标不需要再次声明，用OPEN语句打开它就可以了。<br>　2.4 使用游标数据<br>　在一个游标被打开后，可以使用FETCH语句分别访问它的每一行。FETCH指定检索什么数据（所需的列），检索出来的数据存储在什么地方。它还向前移动游标中的内部行指针，使下一条FETCH语句检索下一行（不重复读取同一行）。<br>　下面给出游标存储过程对取出的数据进行某种实际的处理：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE processorders()</span><br><span class="line">BEGIN</span><br><span class="line">    -- Declare local variables</span><br><span class="line">    DECLARE done BOOLEAN DEFAULT 0;</span><br><span class="line">    DECLARE o INT;</span><br><span class="line">    DECLARE t DECIMAL(8,2);</span><br><span class="line"></span><br><span class="line">    -- Declare the cursor</span><br><span class="line">    DECLARE ordernumbers CURSOR </span><br><span class="line">    FOR</span><br><span class="line">    SELECT order_num FROM orders;</span><br><span class="line">    </span><br><span class="line">    -- Declare continue handler</span><br><span class="line">    DECLARE CONTINUE HANDLER FOR SQLSTATE &apos;02000&apos; SET done=1;</span><br><span class="line"></span><br><span class="line">    -- Create a table to store the results</span><br><span class="line">    CREATE TABLE IF NOT EXISTS ordertotals</span><br><span class="line">        (order_num INT, total DECIMAL(8,2));</span><br><span class="line"></span><br><span class="line">    -- Open the cursor</span><br><span class="line">    OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line">    -- Loop through all rows</span><br><span class="line">    REPEAT</span><br><span class="line">      </span><br><span class="line">        -- Get order number</span><br><span class="line">        FETCH ordernumbers INTO o;</span><br><span class="line">        -- Get the total for this order</span><br><span class="line">        CALL ordertotal(o, 1, t);</span><br><span class="line">        -- Insert order and total into ordertotals</span><br><span class="line">        INSERT INTO ordertotals(order_num, total) VALUES(o, t);</span><br><span class="line">    -- End of loop</span><br><span class="line">    UNTIL done END REPEAT;</span><br><span class="line"> </span><br><span class="line">    -- Close the cursor</span><br><span class="line">    CLOSE ordernumbers;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　此例子中，FETCH是在REPEAT内，因此它反复执行直到done为真（由UNTIL done END REPEAT;规定）。为使它起作用，用一个DEFAULT 0(假，不结束)定义变量done。<br>　而done是通过以下语句设置结束条件：<br>　　<code>DECLARE CONTINUE HANDLER FOR SQLSTATE &#39;02000&#39; SET done=1;</code><br>　这条语句定义了一个CONTINUE HANDLER，它是在条件出现时被执行的代码。这里，它指出当SQLSTATE ‘02000’出现时，SET done=1。SQLSTATE ‘02000’是一个未找到条件，当REPEAT由于没有更多的行供循环而不能继续时，出现这个条件。<br>　<em>（注：DECLARE语句的次序：用DECLARE语句定义的局部变量必须在定义任意游标或句柄之前定义，而句柄必须在游标之后定义。不遵守此顺序将产生错误信息。）</em><br>　<em>（注：重复或循环：除这里使用的REPEAT语句外，MySQL还支持循环语句，它可用来重复执行代码，直到使用LEAVE语句手动退出位置。通常REPEAT语句的语法使它更适合于对游标进行循环。）</em></p>
<h2 id="二十五、触发器"><a href="#二十五、触发器" class="headerlink" title="二十五、触发器"></a>二十五、触发器</h2><p><em>（注：MySQL 5增加了对触发器的支持。）</em><br>1、什么是触发器？<br>　MySQL语句在需要时被执行，存储过程也是如此。但是，如果你想要某条语句（或某些语句）在事件发生时自动执行。例如：</p>
<pre><code>1. 每当增加一个顾客到某个数据表时，都检查其电话号码格式是否正确等；
2. 每当订购一个产品时，都从库存数量中减去订购的数量；
3. 无论何时删除一行，都在某个存档表中保留一个副本。
</code></pre><p>　所有这些例子的共同之处是它们都需要在某个表发生更改时自动处理。这确切地说就是触发器。触发器是MySQL相应以下任意语句而自动执行的一条MySQL语句（或位于BEGIN和END语句之间的一组语句）：<br>　　<code>DELETE、INSERT、UPDATE</code><br>　其它MySQL语句不支持触发器。</p>
<p>2、为什么要使用触发器？<br>　2.1 创建触发器<br>　在创建触发器时，需要给出4条信息：</p>
<pre><code>1. 唯一的触发器名；（保持每个数据库的触发器名唯一）
2. 触发器关联的表；
3. 触发器应该响应的活动（DELETE、INSERT或UPDATE）；
4. 触发器何时执行（处理之前或之后）。
</code></pre><p>　触发器用CREATE TRIGGER语句创建。下面是一个例子：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER newproduct AFTER INSERT ON products</span><br><span class="line">FOR EACH ROW SELECT &apos;Product added&apos;;</span><br></pre></td></tr></table></figure></p>
<p>　在这个例子中，文本Product added将对每个插入的行显示一次。<br>　<em>（注：只有表才支持触发器，视图不支持（临时表也不支持）。）</em><br>　触发器按每个表每个事件每次地定义，每个表每个事件每次只允许一个触发器。因此，每个表最多支持6个触发器（每条INSERT、UPDATE和DELETE的之前和之后）。单一触发器不能与多个时间或多个表关联，所以，如果你需要一个对INSERT和UPDATE操作执行的触发器，则应该定义两个触发器。<br>　<em>（注：如果BEFORE触发器失败，则MySQL将不执行请求的操作。此外，如果BEFORE触发器或语句本身失败，MySQL将不执行AFTER触发器（如果有的话）。）</em><br>　2.2 删除触发器<br>　使用 DROP TRIGGER语句，如下所示：<br>　　<code>DROP TRIGGER newproduct;</code><br>　触发器不能更新或覆盖。为了修改一个触发器，必须先删除它，然后再重新创建。</p>
<p>3、如何使用触发器？<br>　查看已有触发器： <code>show triggers;</code><br>　3.1 INSERT触发器<br>　INSERT触发器在INSERT语句执行之前或之后执行。需要知道以下几点：</p>
<pre><code>1. 在INSERT触发器代码内，可引用一个名为NEW的虚拟表，访问被插入的行；
2. 在BEFORE INSERT触发器中，NEW中的值也可以被更新（允许更改被插入的值）；
3. 对于AUTO_INCREMENT列，NEW在INSERT执行之前包含0，在INSERT执行之后包含新的自动生成值。
</code></pre><p>　示例：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER neworder AFTER INSERT ON orders</span><br><span class="line">FOR EACH ROW SELECT NEW.order_num;</span><br></pre></td></tr></table></figure></p>
<p>　此代码创建一个名为neworder的触发器，它按照AFTER INSERT ON orders执行。在插入一个新订单到orders表时，MySQL生成一个新订单号并保存到order_num中。触发器从NEW.order_num取得这个值并返回它。此触发器必须按照AFTER INSERT执行，因为在BEFORE INSERT语句执行之前，新order_num还没有生成。对于orders的每次插入使用这个触发器将总是返回新的订单号。<br>　<em>（注：通常，将BEFORE用于数据验证和净化（目的是保证插入表中的数据确实是需要的数据）。本提示也适用于UPDATE触发器。）</em><br>　3.2 DELETE触发器<br>　DELETE触发器在DELETE语句执行之前或之后执行。需要知道以下两点：</p>
<pre><code>1. 在DELETE触发器代码内，你可以引用一个名为OLD的虚拟表，访问被删除的行；
2. OLD中的值全都是只读的，不能更新。
</code></pre><p>　示例：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER deleteorder BEFORE DELETE ON orders</span><br><span class="line">FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    INSERT INTO archive_orders(order_num, order_date, cust_id) </span><br><span class="line">    VALUES(OLD.order_num, OLD.order_date, OLD.cust_id);</span><br><span class="line">END;</span><br></pre></td></tr></table></figure></p>
<p>　在任意订单被删除前将执行此触发器。它使用一条INSERT语句将OLD中的值（要被删除的订单）保存到一个名为archive_orders的存档表中。<br>　使用BEFORE DELETE触发器的优点（相对于AFTER DELETE触发器来说）为，如果由于某种原因，订单不能存档，DELETE本身将被放弃。<br>　<em>（注：多语句触发器。触发器deleteorder使用BEGIN和END语句标记触发器体。使用BEGIN END块的好处是触发器能容纳多条SQL语句。）</em><br>　3.3 UPDATE触发器<br>　UPDATE触发器在UPDATE语句执行之前或之后执行。需要知道以下几点：</p>
<pre><code>1. 在UPDATE触发器代码中，你可以引用一个名为OLD的虚拟表访问以前（UPDATE语句前）的值，引用一个名为NEW的虚拟表访问新更新的值。
2. 在BEFORE UPDATE触发器中，NEW中的值可能也被更新（允许更改将要用于UPDATE语句中的值）；
3. OLD中的值全都是只读的，不能更新。
</code></pre><p>　下面的例子保证州名缩写总是大写（不管UPDATE语句中给出的是大写还是小写）：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER updatevendor BEFORE UPDATE ON vendors</span><br><span class="line">FOR EACH ROW SET NEW.vend_state = Upper(NEW.vend_state);</span><br></pre></td></tr></table></figure></p>
<p>　显然，任何数据净化都需要在UPDATE语句之前进行，就像这个例子中一样。每次更新一个行时，NEW.vend_state中的值（将用来更新表行的值）都用Upper(NEW.vend_state)替换。<br>4、关于触发器的进一步介绍<br>　再介绍一些使用触发器时需要记住的重点：</p>
<pre><code>1. 与其他DBMS相比，MySQL 5中支持的触发器相当初级。未来会有一些改进和增强触发器支持的计划。
2. 创建触发器可能需要特殊的安全访问权限，但是，触发器的执行时自动的。如果INSERT、UPDATE、DELETE语句能够执行，则相关的触发器也能执行。
3. 应该用触发器来保证数据的一致性（大小写、格式等）。在触发器中执行这种类型的处理优点是它总是进行这种处理，而且是透明地进行，与客户机应用无关。
4. 触发器的一种非常有意义的使用是创建审计跟踪。使用触发器，把更改（如果需要，甚至还有之前和之后的状态）记录到另一个表非常容易。
5. 遗憾的是，MySQL触发器中不支持CALL语句。这表示不能从触发器内调用存储过程。所需的存储过程代码需要复制到触发器内。
</code></pre><h2 id="二十六、管理事务处理"><a href="#二十六、管理事务处理" class="headerlink" title="二十六、管理事务处理"></a>二十六、管理事务处理</h2><p>（MyISAM和InnoDB是两种常用的引擎，前者不支持事务处理，而后者支持。）<br>1、什么是事务处理<br>　事务处理（transaction processing）可以用来维护数据库的完整性，它保证成批的MySQL操作要么完全执行，要么完全不执行。<br>　下面是关于事务处理需要知道的几个术语：</p>
<pre><code>1. 事务（transaction）指一组SQL语句；
2. 回退（rollback）指撤销指定SQL语句的过程；
3. 提交（commit）指将未存储的SQL语句结果写入数据库表；
4. 保留点（savepoint）指事务处理中设置的临时占位符（placeholder），你可以对它发布回退（与回退整个事务处理不同）。
</code></pre><p>2、如何利用COMMIT和ROLLBACK语句来管理事务处理</p>
<h2 id="二十七、全球化和本地化"><a href="#二十七、全球化和本地化" class="headerlink" title="二十七、全球化和本地化"></a>二十七、全球化和本地化</h2><p>1、字符集和校对顺序<br>　数据库表被用来存储和检索数据。不同的语言和字符集需要以不同的方式存储和检索。<br>　重要术语：</p>
<pre><code>1. 字符集 为字母和符号的集合；
2. 编码 为某个字符集成员的内部表示；
3. 校对 为规定字符如何比较的指令。
</code></pre><p>　<em>（注：校对为什么重要。考虑词APE、apex和Apple。它们处于正确的排序顺序吗？这有赖于你是否想区分大小写。使用区分大小写的校对顺序，这些词有一种排序方式，使用不区分大小写的校对顺序有另外一种排序方式。这不仅影响（如用ORDER BY排序数据），还影响搜索（例如，寻找apple的WHERE子句是否能够找到APPLE）。）</em><br>2、使用字符集和校对顺序<br>　MySQL支持众多的字符集。<br>　为查看所有支持的字符集完整列表，使用以下语句：<br>　　<code>SHOW CHARACTER SET;</code><br>　这条语句显示所有可用的字符集以及每个字符集的描述和默认校对。<br>　为了查看所支持校对的完整列表，使用以下语句：<br>　　<code>SHOW COLLATION;</code><br>　此语句显示所有可用的校对，以及它们适用的字符集。可以看到有的字符集具有不止一种校对。<br>　通常系统管理在安装时定义一个默认的字符集和校对。此外，也可以在创建数据库时，指定默认的字符集和校对。为了确定所用的字符集和校对，可以使用以下语句：<br>　　<code>SHOW VARIABLES LIKE &#39;character%&#39;;</code><br>　　<code>SHOW VARIABLES LIKE &#39;collation%&#39;;</code><br>　实际上，字符集很少是服务器范围（甚至数据库范围）的设置。不同的表，甚至不同的列都可能需要不同的字符集，而且两者都可以创建表时指定。<br>　一般，MySQL如下确定使用什么样的字符集和校对：</p>
<pre><code>1. 如果指定CHARACTER SET和COLLATE两者，则使用这些值。
2. 如果只指定CHARACTER SET，则使用此字符集及其默认的校对（如SHOW CHARACTER SET的结果中所示）。
3. 如果既不指定CHARACTER SET，也不指定COLLATE，则使用数据库默认。
</code></pre><p>　最后，值得注意的是，如果绝对需要，串可以在字符集之间进行转换。为此，使用Cast()或Convert()函数。</p>
<h2 id="二十八、安全管理"><a href="#二十八、安全管理" class="headerlink" title="二十八、安全管理"></a>二十八、安全管理</h2><p>1、访问控制<br>　MySQL服务器的安全基础是：用户应该对他们需要的数据具有适当的访问权，既不能多也不要能少。换句话说，用户不能对过多的数据具有过多的访问权。<br>　考虑以下内容：</p>
<pre><code>1. 多数用户只需要对表进行读和写，但少数用户甚至需要能创建和删除表。
2. 某些用户需要读表，但可能不需要更新表；
3. 你可能想允许用户添加数据，但不允许它们删除数据；
4. 某些用户（管理员）可能需要处理用户账号的权限，但多数用户不需要；
5. 你可能想让用户通过存储过程访问数据，但不允许他们直接访问数据；
6. 你可能想根据用户登录的地点限制对某些功能的访问。
</code></pre><p>2、管理用户<br>　MySQL用户账号和信息存储在名为mysql的MySQL数据库中。一般不需要直接访问mysql数据库和表，但有时需要直接访问。需要直接访问它的时机之一是需要获得所有用户的账号列表时。<br>　mysql数据库有一个名为user的表，它包含所有用户账号。<br>　2.1 创建用户账号<br>　使用CREATE USER语句：<br>　　<code>CREATE USER ben IDENTIFIED BY &#39;p@$$wOrd&#39;;</code><br>　2.2 重新命名一个用户账号<br>　使用RENAME USER语句：<br>　　<code>RENAME USER ben TO bforta;</code><br>　<em>（注：仅MySQL5或之后的版本支持 RENAME USER，为了在以前的MySQL中重命名一个用户，可使用UPDATE直接更新user表。）</em><br>　2.3 删除用户账号<br>　使用DROP USER语句：<br>　　<code>DROP USER bforta;</code><br>　<em>（注：自MySQL5以来，DROP USER删除用户账号和所有相关的账号权限。在MySQL5之前，DROP USER只能用来删除用户账号，不能删除相关账号权限。因此，如果使用旧版本的MySQL，需要先用REVOKE删除和账号相关的权限，然后再用DROP USER删除账号。）</em><br>　2.4 设置访问权限</p>
<pre><code>1. 查看赋予用户账号的权限，使用SHOW GRANTS FOR语句，如下：
 `SHOW GRANTS FOR bforta;`
2. 设置权限，使用GRANT语句。GRANT要求至少给出以下信息：
 （1）要授予的权限；
 （2）被授予访问权限的数据库或表；
 （3）用户名。
如下例子给出GRANT的用法：
 `GRANT SELECT ON crashcourse.* TO bforta;`
此GRANT允许用户在crashcourse.*（crashcourse数据库的所有表）上使用SELECT。通过只授予SELECT访问权限，用户bforta对crashcourse数据库中的所有数据具有只读访问权限。
3. GRANT的反操作为REVOKE，用它来撤销特定的权限。举个例子：
 `REVOKE SELECT ON crashcourse.* FROM bforta;`
这条REVOKE语句取消刚赋予用户bforta的SELECT访问权限。被撤销的访问权限必须存在，否则会出错。
GRANT和REVOKE可在几个层次上控制访问权限：
 （1）整个服务器，使用GRANT ALL和REVOKE ALL;
 （2）整个数据库，使用ON database.*;
 （3）特定的表，使用ON database.table;
 （4）特定的列；
 （5）特定的存储过程。
可以授予或撤销的每个权限：
 权限            |   说明
 ----------------|------------------------------
 ALL             |   除GRANT OPTION外的所有权限
 SELECT          |   使用SELECT
 INSERT          |   使用INSERT
 UPDATE          |   使用UPDATE
 DELETE          |   使用DELETE
 CREATE          |   使用CREATE TABLE
 DROP            |   使用DROP TABLE
 GRANT OPTION    |   使用GRANT和REVOKE
 ALTER           |   使用ALTER TABLE
 ALTER ROUTINE   |   使用ALTER PROCEDURE和DROP PROCEDURE
 CREATE ROUTINE  |   使用CREATE PROCEDURE
 CREATE TEMPORARY TABLES |  使用CREATE TEMPORARY TABLE
 CREATE USER     |   使用CREATE USER、DROP USER、RENAME USER和REVOKE ALL PRIVILEGES
 CREATE VIEW     |   使用CREATE VIEW
 INDEX           |   使用CREATE INDEX和DROP INDEX
 LOCK TABLES     |   使用LOCK TABLES
 EXECUTE         |   使用CALL和存储过程
 FILE            |   使用SELECT INTO OUTFILE和LOAD DATA INFILE
 PROCESS         |   使用SHOW FULL PROCESSLIST
 RELOAD          |   使用FLUSH
 REPLICATION CLIENT | 服务器位置的访问
 REPLICATION SLAVE  | 由复制从属使用
 SHOW DATABASES  |   使用SHOW DATABASES
 SHOW VIEW       |   使用SHOW CREATE VIEW
 SHUTDOWN        |   使用mysqladmin shutdown(用来关闭MySQL)
 SUPER           |   使用CHANGE MASTER、KILL、LOGS、PURGE、MASTER和SET GLOBAL。还允许mysqladmin调试登录
 USAGE           |   无访问权限
使用GRANT和REVOKE，在结合列出的权限，你能对用户可以就你的宝贵数据做什么事情和不能做什么事情具有完全的控制。
（注：多个权限用逗号分隔）
</code></pre><p><em>（注：未来授权：在使用GRANT和REVOKE时，用户账号必须存在，但对所涉及的对象没有这个要求。这允许管理员在创建数据库和表之前设计和实现安全措施。 这样做的副作用是，当某个数据库或表删除时（用DROP语句），相关的访问权限仍然存在。而且，如果将来重新创建该数据库或表，这些权限仍然起作用。）</em></p>
<h2 id="二十九、数据库维护"><a href="#二十九、数据库维护" class="headerlink" title="二十九、数据库维护"></a>二十九、数据库维护</h2><p>MySQL主要的日志文件有以下几种：</p>
<pre><code>1. 错误日志。它包含启动和关闭问题以及任意关键错误的细节。此日志通常名为hostname.err，位于data目录中。此日志名可用--log-error命令行选项更改。
2. 查询日志。它记录所有MySQL活动，在诊断问题时非常有用。此日志文件可能会很快地变得非常大，因此不应该长期使用它。此日志通常名为hostname.log，位于data目录中。此名字可以用--log命令行选项更改。
3. 二进制日志。它记录更新过数据（或者可能更新过数据）的所有语句。此日志通常名为hostname-bin，位于data目录内。此名字可以用--log-bin命令行选项更改。注意，这个日志文件是MySQL5中添加的，以前的MySQL版本中使用的是更新日志。
4. 缓慢查询日志。顾名思义，此日志记录执行缓慢的任何查询。这个日志在确定数据库何处需要优化很有用。此日志通常名为hostname-slow.log，位于data目录中。此名字可以用--log-slow-queries命令行选项更改。
</code></pre><p>　在使用日志时，可用FLUSH LOGS语句来刷新和重新开始所有日志文件。</p>
<h2 id="三十、改善新能"><a href="#三十、改善新能" class="headerlink" title="三十、改善新能"></a>三十、改善新能</h2><p>下面是一些性能优化的技巧：</p>
<pre><code>1. 一般来说，使用存储过程比一条一条地执行其中的各条MySQL语句快；
2. 使用正确的数据类型；
3. 绝不要检索比需求还要多的数据。换言之，不要用SELECT *（除非你真正需要每个列）。
4. 必须索引数据库表以改善数据检索的性能；但注意，索引改善数据检索的性能，但损害数据插入、删除和更新的性能；
5. 使用多条SELECT语句和连接它们的UNION语句，能够获得极大的性能改进；
6. LIKE很慢。一般来说，最好是使用FULLTEXT而不是LIKE；
7. 最重要的规则就是，每条规则在某些条件下都会被打破。
</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/书籍/" rel="tag"># 书籍</a>
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/07/MySQL 《必知必会》-基础知识/" rel="next" title="《MySQL必知必会》-基础知识">
                <i class="fa fa-chevron-left"></i> 《MySQL必知必会》-基础知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/07/总结-MySQL数据类型/" rel="prev" title="总结-MySQL数据类型">
                总结-MySQL数据类型 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/IMG_2796.JPG"
                alt="Zheng Benwu" />
            
              <p class="site-author-name" itemprop="name">Zheng Benwu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">139</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/bluce-ben" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:zheng_benwu@163.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#二十二、使用视图"><span class="nav-number">1.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x4E8C;&#x3001;&#x4F7F;&#x7528;&#x89C6;&#x56FE;" class="headerlink" title="&#x4E8C;&#x5341;&#x4E8C;&#x3001;&#x4F7F;&#x7528;&#x89C6;&#x56FE;"></a>&#x4E8C;&#x5341;&#x4E8C;&#x3001;&#x4F7F;&#x7528;&#x89C6;&#x56FE;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十三、使用存储过程"><span class="nav-number">2.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x4E8C;&#x5341;&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;"></a>&#x4E8C;&#x5341;&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十四、使用游标"><span class="nav-number">3.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x56DB;&#x3001;&#x4F7F;&#x7528;&#x6E38;&#x6807;" class="headerlink" title="&#x4E8C;&#x5341;&#x56DB;&#x3001;&#x4F7F;&#x7528;&#x6E38;&#x6807;"></a>&#x4E8C;&#x5341;&#x56DB;&#x3001;&#x4F7F;&#x7528;&#x6E38;&#x6807;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十五、触发器"><span class="nav-number">4.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x4E94;&#x3001;&#x89E6;&#x53D1;&#x5668;" class="headerlink" title="&#x4E8C;&#x5341;&#x4E94;&#x3001;&#x89E6;&#x53D1;&#x5668;"></a>&#x4E8C;&#x5341;&#x4E94;&#x3001;&#x89E6;&#x53D1;&#x5668;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十六、管理事务处理"><span class="nav-number">5.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x516D;&#x3001;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#x5904;&#x7406;" class="headerlink" title="&#x4E8C;&#x5341;&#x516D;&#x3001;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#x5904;&#x7406;"></a>&#x4E8C;&#x5341;&#x516D;&#x3001;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#x5904;&#x7406;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十七、全球化和本地化"><span class="nav-number">6.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x4E03;&#x3001;&#x5168;&#x7403;&#x5316;&#x548C;&#x672C;&#x5730;&#x5316;" class="headerlink" title="&#x4E8C;&#x5341;&#x4E03;&#x3001;&#x5168;&#x7403;&#x5316;&#x548C;&#x672C;&#x5730;&#x5316;"></a>&#x4E8C;&#x5341;&#x4E03;&#x3001;&#x5168;&#x7403;&#x5316;&#x548C;&#x672C;&#x5730;&#x5316;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十八、安全管理"><span class="nav-number">7.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x516B;&#x3001;&#x5B89;&#x5168;&#x7BA1;&#x7406;" class="headerlink" title="&#x4E8C;&#x5341;&#x516B;&#x3001;&#x5B89;&#x5168;&#x7BA1;&#x7406;"></a>&#x4E8C;&#x5341;&#x516B;&#x3001;&#x5B89;&#x5168;&#x7BA1;&#x7406;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十九、数据库维护"><span class="nav-number">8.</span> <span class="nav-text"><a href="#&#x4E8C;&#x5341;&#x4E5D;&#x3001;&#x6570;&#x636E;&#x5E93;&#x7EF4;&#x62A4;" class="headerlink" title="&#x4E8C;&#x5341;&#x4E5D;&#x3001;&#x6570;&#x636E;&#x5E93;&#x7EF4;&#x62A4;"></a>&#x4E8C;&#x5341;&#x4E5D;&#x3001;&#x6570;&#x636E;&#x5E93;&#x7EF4;&#x62A4;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三十、改善新能"><span class="nav-number">9.</span> <span class="nav-text"><a href="#&#x4E09;&#x5341;&#x3001;&#x6539;&#x5584;&#x65B0;&#x80FD;" class="headerlink" title="&#x4E09;&#x5341;&#x3001;&#x6539;&#x5584;&#x65B0;&#x80FD;"></a>&#x4E09;&#x5341;&#x3001;&#x6539;&#x5584;&#x65B0;&#x80FD;</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zheng Benwu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0xNn1pwwQEUyuYJA5FwnLGKm-gzGzoHsz", "hYKQqspX8ivguvgDs3vgDhmC");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
