---
title: socket 详解
date: 2018-04-10 16:13:54
categories:
- 计算机网络
tags:
- 计算机网络
---
#### 1、网络中进程之间是如何通信？
本地的进程间通信（IPC）有很多种方式，但可以总结为下面4类：
* 消息传递（管道、FIFO、消息队列）
* 同步（互斥量、条件变量、读写锁、文件和写记录锁、信号量）
* 共享内存（匿名的和具名的）
* 远程过程调用（Solaris门和Sun RPC）

在本地我们通过进程 PID 来唯一标识一个进程，但是在网络中是行不通的。而 TCP/IP 协议簇帮我们解决了这个问题，<font color="red">网络层的“IP地址”</font>可以唯一标识网络中的主机，<font color="red">传输层的“协议+端口”</font>可以唯一标识主机中的应用程序（进程）。这样利用三元组（ip地址、协议、端口）就可以标识网络中的进程了，网络中的进程通信就可以利用这个标志与其它进程进行交互。

<!--more-->

#### 2、什么是socket
那什么是socket呢？其实，Socket 就是编程接口（API），是对 TCP/IP 的封装，对外提供的接口。网络中进程间通信采用的就是 socket（套接字）。
看下图即可明白 socket：
![](/uploads/2018/04/linux_socket_04.png '图1')
![](/uploads/2018/04/linux_socket_03.png '图2')

>几种典型的应用编程接口：
* Berkeley UNIX 操作系统定义了一种 API，称为套接字接口（socket Interface），简称<font color="red">套接字（socket）</font>。
* 微软公司在其操作系统中采用了套接字接口 API，形成了一个稍有不同的 API，并称为 Windows Socket Interface，<font color="red">WINSOCK</font>。
* AT&T 为其 UNIX 系统 V 定义了一种 API，简写为 <font color="red">TLI</font>（Transport Layer Interface）(已经被淘汰了)。


#### 3、套接字（socket）概念
套接字（socket）是通信的基石，是支持TCP/IP协议的网络通信的基本操作单元。它是网络通信过程中端点的抽象表示，包含进行网络通信必须的五种信息：连接使用的协议，本地主机的IP地址，本地进程的协议端口，远地主机的IP地址，远地进程的协议端口。

应用层通过传输层进行数据通信时，TCP会遇到同时为多个应用程序进程提供并发服务的问题。多个TCP连接或多个应用程序进程可能需要通过同一个 TCP协议端口传输数据。为了区别不同的应用程序进程和连接，**许多计算机操作系统为应用程序与TCP／IP协议交互提供了**<font color="red">套接字(Socket)接口</font>（由图2可看出来）。应用层可以和传输层通过Socket接口，区分来自不同应用程序进程或网络连接的通信，实现数据传输的并发服务。


#### 4、socket原理
要想明白 Socket，必须要理解TCP连接。
>建立TCP连接的“三次握手”：
* **第一次：**客户端向服务器发送SYN包(syn=j)，同时自己处于SYN_SEND状态。
* **第二次：**服务器端收到SYN包后，必须确认客户的SYN(syn=j+1)，同时也发送一个SYN包(syn=k)，即SYN+ACK包，此时服务器进入SYN_RECV状态。
* **第三次：**客户端收到服务器发来的SYN+ACK包，就向服务器发送SYN(syn=k+1)，发送完毕后，服务器和客户端都进入ESTABLISHED状态。完成三次握手。

握手过程中，并不传输数据。在握手后，服务器与客户端才开始传输数据，理想状态下，TCP连接一旦建立，在通讯双方中的任何一方主动断开连接之前，TCP连接会一直保持下去。断开连接时服务器和客户端均可以主动发起断开TCP连接的请求，断开过程需要经过“四次握手”。

##### （1）socket 连接
Socket连接，至少需要一对套接字，分为 clientSocket，serverSocket。连接分为3个步骤：
* **服务器监听：**服务器并不定位具体客户端的套接字，而是时刻处于监听状态。
* **客户端请求：**客户端的套接字要描述它要连接的服务器的套接字。提供地址和端口号，然后向服务器套接字提出连接请求。
* **连接确认：**当服务器套接字收到客户端套接字发来的请求后，就响应客户端套接字的请求，并建立一个新的线程，把服务器端的套接字的描述发给客户端，一旦客户端确认了此描述，就正式建立连接。而服务器套接字继续处于监听状态，继续接收其他客户端套接字的连接请求。

创建Socket连接的时候，可以指定传输层协议。可以是TCP或者UDP，当用TCP连接，该Socket就是个TCP连接。

##### （2）socket 函数
Socket接口对外提供的函数如下：
<style type="text/css">
	table th:first-of-type{
		width: 15%;
	}
</style>

函数名      | 说明
------------|------------------
socket      | 创建套接字 
connect     | “连接”远端服务器（仅用于客户端）
closesocket | 释放/关闭套接字
bind        | 绑定套接字的本地IP地址和端口号（通常客户端不需要）
listen      | 配置服务端TCP套接字为监听模式，并设置队列大小（仅用于服务器端TCP套接字）
accept      | 接受/提取一个连接请求，创建新套接字，通过新套接（仅用于服务器端的TCP套接字）
recv        | 接收数据（用于TCP套接字或连接模式的客户端UDP套接字）
recvfrom    | 接收数据报（用于非连接模式的UDP套接字）
send        | 发送数据（用于TCP套接字或连接模式的客户端UDP套接字）
sendto      | 发送数据报（用于非连接模式的UDP套接字）
setsockopt  | 设置套接字选项参数
getsockopt  | 获取套接字选项参数

##### （3）socket 调用流程
![](/uploads/2018/04/linux_socket_05.png)

##### （4）socket 管理
通过 Socket描述符表来进行管理，每个进程中有一个描述符表。当应用进程创建套接字时，操作系统分配一个数据结构存储该套接字相关信息。如下图所示：
![](/uploads/2018/04/linux_socket_02.png)

##### （5）并发面向连接服务器基本流程
![](/uploads/2018/04/linux_socket_01.png)
**主线程1：**创建（主）套接字，并绑定熟知端口号；
**主线程2：**创建（主）套接字为被动监听模式，准备用于服务器；
**主线程3：**反复调用accept() 函数接收下一个<font color="red">连接请求</font>（通过主套接字），并创建一个新的子线程处理该客户端响应；
**子线程1：**接收一个客户端的<font color="red">服务请求</font>（通过新创建的套接字）；
**子线程2：**遵循应用层协议与特定客户进行交互；
**子线程3：**关闭/释放连接并推出（线程终止）。