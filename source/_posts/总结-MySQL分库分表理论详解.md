---
title: 总结-MySQL分库分表理论详解
date: 2017-12-08 11:05:56
categories: 
- [MySQL, 架构]
tags:
- MySQL
- 架构
---
### 为什么要分库/分表？
　当一张的数据达到几百万时，你查询一次所花的时间会变多，如果有联合查询的话，我想有可能会死在那儿了。分表的目的就在于此，减小数据库的负担，缩短查询时间。
　mysql中有一种机制是表锁定和行锁定，为什么要出现这种机制，是为了保证数据的完整 性，我举个例子来说吧，如果有二个sql都要修改同一张表的同一条数据，这个时候怎么办呢，是不是二个sql都可以同时修改这条数据呢？很显然mysql 对这种情况的处理是，一种是表锁定（myisam存储引擎），一个是行锁定（innodb存储引擎）。表锁定表示你们都不能对这张表进行操作，必须等我对 表操作完才行。行锁定也一样，别的sql必须等我对这条数据操作完了，才能对这条数据进行操作。如果数据太多，一次执行的时间太长，等待的时间就越长，这 也是我们为什么要分库/分表的原因。
<!--more-->
### 怎么分库/分表？
**分库：**
（1）mysql集群与主从复制、读写分离：
>	　主从复制、读写分离只是一种策略。
>	　读写分离策略，最大限度提高了应用中读取数据的速度和并发量。（原理是，由于MySQL中有一种机制是表锁定和行锁定，所以写操作会锁定，而且写操作比读操作更费时，因为不仅要写入数据，还要更新索引。因此，把读写分离，可极大提高数据库的性能。）
>	　主从复制策略，可以降低单台机器的负载，同时最大限度的降低宕机造成的损失。
>	　集群：解决了数据库宕机带来的单点数据库不能访问的问题。

（2）垂直分库：一般根据业务逻辑来分，例如按照用户、商品、日志等。
（3）水平分库：就是对业务进行主从复制、读写分离的操作。当一主一从不能满足时，就需要一主多从的形式满足读操作。
**分表：**
（1）垂直分表：根据字段的使用情况来进行划分，把一些常使用的字段放在一个表中。不经常使用（读和写）的放在一个表中，可通过一个外键关联。（使用外键时要注意该表是否读大于写，如果不能使用外键，直接将主表搜索ID放到附表即可一样关联。）
（2）水平分表：水平分表方式多样，例如：
>	1. 按时间分表 
>	　这种分表方式有一定的局限性，当数据有较强的实效性，如微博发送记录、微信消息记录等，这种数据很少有用户会查询几个月前的数据，如就可以按月分表。
>	2. 按数据迁移的方式 
>	　当一些很久之前的数据，很少再查询。比如员工工资表，我们可以只存今年的工资情况。而历史数据我们可以迁移到一张salary_old表中,保证数据不会丢失。但也可以用来查询。每天定期把今年中的最早一天的记录归入旧表中。这样一方面可以解决性能问题，最多也只需要读2张表就完成了。
>	3. 按热度拆分
>	　典型的像贴吧这种有高点击率的词条，也有低点击率的词条，如果一个词条一张表，那得多少表啊，所以一般这种情况就会对高点击率的词条生成 一张表，低热度的词条都放在一张大表里，待低热度的词条达到一定的贴数后，比如1W条，再把低热度的表单独拆分成一张表。

（3）分表实现技术方式：
	1. 分两张表的情况，可使用对2取余判断奇偶
	2. 分10张表以内的，可使用对10或10以内数字取模来实现
	3. 数据量大的，可根据MD5哈希取位数来实现（位数越大，表数越大）
	4. 利用merge存储引擎来实现分表

### 实际工作中如何分库/分表？
　做什么事都有一个度，超过这个度就会变得很差，不能一味的做数据库服务器集群，硬件是要花钱买的，也不要一味的分表，分出来1000 表，mysql的存储归根到底还以文件的形势存在硬盘上面，一张表对应三个文件，1000个分表就是对应3000个文件，这样检索起来也会变的很慢 。
　建议是：硬件与软件一起使用。

### 分库/分表后产生的问题？
（1）分库分表维度的问题 
　假如用户购买了商品,需要将交易记录保存取来，如果按照用户的纬度分表，则每个用户的交易记录都保存在同一表中，所以很快很方便的查找到某用户的购买情况，但是某商品被购买的情况则很有可能分布在多张表中，查找起来比较麻烦。反之，按照商品维度分表，可以很方便的查找到此商品的购买情况，但要查找到购买人的交易记录比较麻烦。 
　所以常见的解决方式有： 
	1. 通过扫表的方式解决，此方法基本不可能，效率太低了。 
	2. 记录两份数据，一份按照用户纬度分表，一份按照商品维度分表。 
	3. 通过搜索引擎解决，但如果实时性要求很高，又得关系到实时搜索。 
（2）联合查询的问题 
　联合查询基本不可能，因为关联的表有可能不在同一数据库中。 
（3）避免跨库事务 
　避免在一个事务中修改db0中的表的时候同时修改db1中的表，一个是操作起来更复杂，效率也会有一定影响。 
（4）尽量把同一组数据放到同一DB服务器上 
　如将卖家a的商品和交易信息都放到db0中，当db1挂了的时候，卖家a相关的东西可以正常使用。也就是说避免数据库中的数据依赖另一数据库中的数据。

### 分库时需要注意的问题：
（1）联结不能跨库操作
（2）InnoDB引擎的外键不能跨库
（3）避免跨库事务操作
（4）尽量把同一组数据放到同一个数据库上

**参考博文：**
*[mysql 分库分表的方法](https://yq.aliyun.com/articles/42644)*
*[数据库水平切分的实现原理解析——分库，分表，主从，集群，负载均衡器](http://www.cnblogs.com/zhongxinWang/p/4262650.html)*
*[数据库读写分离和垂直分库、水平分表](http://blog.csdn.net/lzf4712/article/details/47780303)*
*[linux mysql proxy 的安装，配置，以及读写分离](http://blog.51yip.com/mysql/399.html)*