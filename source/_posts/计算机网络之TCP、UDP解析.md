---
title: 计算机网络之TCP、UDP解析
date: 2018-12-17 16:25:45
categories:
- 计算机网络
tags:
- 计算机网络
---
#### OSI模型
OSI模型最初是用来作为开发网络通信协议族的一个工业参考标准。通过严格遵守OSI模型，不同的网络技术之间可以轻易地实现互操作。
![](/uploads/2018/12/network_osi.png)
<!--more-->

OSI模型包含许多被分割成层的组件。在网络数据通信的过程中，每一层完成一个特定的任务。当传输数据的时候，每一层接收到上面层格式化后的数据，对数据进行操作，然后把它传给下面的层。当接收数据的时候，每一层接收到下面层传过来的数据，对数据进行解包，然后把它传给上一层。

OSI模型的一个关键概念是虚电路。兼容OSI模型的网络栈的每一部分都不知道其上面层和下面层的行为和细节；它只是向上和向下传输数据。就模型的层次而言，每一层都有一虚电路直接连接目的主机上的对应层。就每一层而言，它的数据在目的层被解包的方式和被打包的方式是完全一样的。层不知道传输数据的实际细节；它们只知道数据是从周围层中传过来的。


#### TCP/IP协议栈
OSI模型是一种通用的、标准的、理论模型，今天市场上没有一个流行的网络协议完全遵守OSI模型，TCP/IP也不例外，TCP/IP协议族有自己的模型，被称为TCP/IP协议栈，又称DOD模型（Department of defense）
![](/uploads/2018/12/network_tcp_ip_01.png)

>问：TCP/IP是什么？
答：TCP/IP是协议栈，并不是单指TCP协议、IP协议或者HTTP协议。仅仅是一个协议族，是一个统称。


#### TCP、UDP概述
##### （1）用户数据报协议UDP（User Datagram Protocol）：UDP用户数据报
UDP在传送数据之前不需要先建立连接。远地主机的传输层在收到UDP报文后，不需要给出任何确认。虽然UDP不提供可靠交付，但在某些情况下UDP却是一种最有效的工作方式。

##### （2）传输控制协议TCP（Transmission Control Protocol）：TCP报文段
TCP则提供面向连接的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。TCP不提供广播或多播服务。由于TCP要提供可靠的、面向连接的传输服务，因此不可避免地增加了许多的开销，如确认、流量控制、计时器以及连接管理等。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源。

**使用UDP和TCP协议的各种应用和应用层协议**

应用		|	应用层协议		|	运输层协议
------------|-------------------|------------------
域名解析	|	DNS				|	UDP
文件传送	|	TFTP			|	UDP
路由选择协议|	RIP				|	UDP
IP地址配置	| BOOTP，DHCP		|	UDP
网络管理	|	SNMP			|	UDP
远程文件服务器|	NFS				|	UDP
多播		|	IGMP			|	UDP
万维网		|	HTTP			|	TCP
文件传送 	|	FTP				|	TCP
远程终端接入|	TELNET			|	TCP

>题外话：如何将一个进程通过网络送到对应服务器的进程中？
解决这个问题的方法就是在传输层使用协议端口号（protocol port number），或通常简称为端口（port）。这就是说，虽然通信的终点是应用进程，但我们只要把要传送的报文交到目的主机的某一个合适的目的端口（通过IP来完成），剩下的工作（即最后交付给目的进程）就由TCP来完成。
>>请注意，这种在协议栈层间的抽象的协议端口是软件端口，和路由器或交换机上的硬件端口（应该称为接口）是完全不同的概念。硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与传输实体进行层间交互的一种地址。

>扩展：TCP/IP的传输层用一个16位端口号来标志一个端口。但请注意，端口号只具有本地意义（即本机机器来说才有意义），它只是为了标志本计算机应用层中的各个进程在和传输层交互时的层间接口。16位的端口号可允许有65535个不同的端口号，这个数目对一个计算机来说是足够用的。


#### UDP解析
##### 1、主要特点：
（1）UDP是**无连接**的，即发送数据之前不需要建立连接（当然发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
（2）UDP使用**尽最大努力交付**，即不保证可靠交付，因此主机不需要维持复杂的连接状态表（这里面有许多参数）。
（3）UDP是**面向报文**的。发送方的UDP对应程序交下来的报文，在添加首部后就向下交付给IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是**保留这些报文的边界**。这就是说，应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文。如下图，在接收方的UDP，对IP层交上来的UDP用户数据报，在去除首部后就原封不动地交付给上层的应用进程。
因此，<font color="red">应用程序必须选择合适大小的报文。</font>若报文太长，UDP把它交给IP层后，IP层在传送时可能要进行分片，这回降低IP层的效率。反之，若报文太短，UDP把它交给IP层后，会使IP数据报的首部的相对长度太大，这也降低了IP层的效率。
![](/uploads/2018/12/network_udp_01.png)
（4）UDP**没有拥塞控制**，因此网络出现的拥塞不会使源主机的发送速率降低。（这对某些实时应用是很重要的。）
（5）UDP**支持一对一、一对多、多对一和多对多的交互通信**。
（6）UDP的**首部开销小**，只有8个字节，比TCP的20个字节的首部要短。

>虽然某些实时应用需要使用没有拥塞控制的UDP，但当很多的源主机同时都向网络发送高速率的实时视频流时，网络就有可能发生拥塞，结果大家都无法正常接收。因此，不适用拥塞控制功能的UDP有可能会引起网络产生严重的拥塞问题。


##### 2、UDP的首部格式
用户数据报UDP有两个字段：数据字段和首部字段。首部字段很简单，只有8个字节，由四个字段组成，每个字段的长度都是两个字节。各字段意义如下：

报头字段名		| 位数 |	说明
----------------|------|--------------------------
源端口号 		| 16   | 发送主机的UDP端口
目的端口号		| 16   | 目标主机的UDP端口
消息长度		| 16   | UDP用户数据报的长度，其最小值是8（仅有首部）
校验和			| 16   | 检测UDP用户数据报在传输中是否有错。有错就丢弃

![](/uploads/2018/12/network_udp_02.png)
当传输层从IP层收到UDP数据报时，就根据首部中的目的端口，把UDP数据报通过相应的端口，上交最后的终点——应用进程。


#### TCP解析
##### 1、主要特点：
（1）TCP是**面向连接的传输层协议**。这就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。
（2）每一条TCP连接只能有**两个端点（endpoint）**，每一条TCP连接只能是点对点的（一对一）。
（3）TCP提供**可靠交付**的服务。也就是说，通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达。
（4）TCP提供**全双工通信**。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。
（5）面向字节流。TCP中的**“流”（stream）指的是流入到进程或从进程流出的字节序列**。“面向字节流”的含义是：虽然应用程序和TCP的交互时一次一个数据块（大小不等），但TCP把应用程序交下来的数据看成仅仅是一连串的**无结构的字节流。**TCP并不知道所传送的字节流的含义。TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系（例如，发送方应用程序交给发送方的TCP共10个数据块，但接收方的TCP可能只用了4个数据块就把收到的字节流交付给了上层的应用程序）。但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。当然，接收方的应用程序必须有能力识别收到的字节流，把它还原成有意义的应用层数据。

##### 2、TCP的连接
TCP把连接作为最基本的抽象。TCP的许多特性都与TCP是面向连接的这个基本特性有关。
前面已经说过，每一条TCP连接有两个端点。那么，TCP连接的端点是什么呢？ 不是主机，不是主机的IP地址，不是应用进程，也不是传输层的协议端口。 TCP连接的端点叫做**套接字（socket）或插口**。根据RFC 793的定义：端口号**拼接到（contatenated with）IP**地址即构成了套接字。

<font color="red">每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定。</font>即：
	TCP连接 ::= {socket1, socket2} = {(IP1:port1), (IP2:port2)}

>应用编程接口API（Application Programming Interface），即传输层与应用程序之间的一种接口，称为socket API，并简称为socket。

##### 3、TCP报文段的首部格式
TCP虽然是面向字节流的，但TCP传送的数据单元却是报文段。一个TCP报文段分为首部和数据两部分，而TCP的全部功能都提现在它首部中各字段的作用。只有弄清楚TCP首部各字段的作用才能掌握TCP的工作原理。

TCP报文段首部的前20个字节是固定的，如下图，后面有4N字节是根据需要而增加的选项（N是整数）。因此TCP首部的最小长度是20字节。
![](/uploads/2018/12/network_tcp_01.png)

报头字段名		| 位数 |	说明
----------------|------|--------------------------
源端口号		| 16   | 本地通信端口，支持TCP的多路复用机制
目的端口号		| 16   | 远地通信端口，支持TCP的多路复用机制
序号（SEQ）		| 32   | 数据段第一个数据字节的序号（除含有SYN的段外）；SYN段的SYN序号（建立本次连接的初始序号）
确认号（ACK）	| 32   | 表示本地希望接收的下一个数据字节的序号
数据偏移		| 4	   | 指出该段中数据的初始位置（以32位为单位）
保留			| 6	   | 保留为今后使用，但目前应置为0
控制字段（CTL） |	   |
	URG			| 1    | 紧急指针字段有效标志，即该段中携带紧急数据
	ACK			| 1    | 确认号字段有效标志
	PSH			| 1    | PUSH操作的标志
	RST			| 1    | 要求异常终止通信连接的标志
	SYN 		| 1    | 建立同步连接的标志
	FIN			| 1	   | 本地数据发送已结束，终止连接的标志
窗口			| 16   | 本地接收窗口尺寸，即本地接收缓冲区大小
校验和			| 16   | 包括TCP报头和数据在内的校验和
紧急指针        | 16   | 从段序号开始的正向位移，指向紧急数据的最后一个字节
选项			| 可变 | 提供任选的服务
填充			| 可变 | 保证TCP报头以32位为边界对齐

##### 4、TCP的连接与释放
用三次握手建立TCP连接：
![](/uploads/2018/12/network_tcp_02.png)

TCP连接释放的过程：
![](/uploads/2018/12/network_tcp_03.png)

为什么A在TIME-WAIT状态必须等待2MSL的时间呢？这有两个理由。
* 第一，为了保证A发送的最后一个ACK报文段能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN+ACK报文段的确认。B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个重传的FIN+ACK报文段。接着A重传一次确认，重新启动2MSL计时器。最后，A和B都正常进入到CLOSED状态。如果A在TIME-WAIT状态不等待一段时间，而是在发送完ACK报文段后立即释放连接，那么就无法收到B重传的FIN+ACK报文段，因而也不会再发送一次确认报文段。这样，B就无法按照正常步骤进入CLOSED状态。
* 第二，防止“已失效的连接请求报文段”出现在本连接中。A在发送完最后一个ACK报文段后，再经过时间2MSL，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。
B只要收到了A发出的确认，就进入CLOSED状态。同样，B在撤销相应的传输控制块TCB后，就结束了这次的TCP连接。我们注意到，B结束TCP连接的时间要比A早一些。

>除时间等待计时器外，TCP还设有一个**保活计时器（keepalive timer）**。设想有这样的情况：客户已主动与服务器建立了TCP连接。但后来客户端的主机突然出故障。显然，服务器以后就不能再收到客户发来的数据。因此，应当有措施使服务器不要再白白等待下去。这就是使用保活计时器。服务器每收到一次客户的数据，就重新设置保活计时器，时间的设置通常是两小时。若两小时没有收到客户的数据，服务器就发送一个探测报文段，以后则每隔75秒发送一次。若一连发送10个探测报文段后仍无客户的响应，服务器就认为客户端出了故障，接着就关闭这个连接。

##### 5、TCP高级知识点概述
（1）TCP是怎么保证可靠传输的？
通过超时重传、选择确认、滑动窗口机制来保证可靠传输。

（2）TCP的keepalive保活机制？
通过保活计时器来确保TCP的keepalive的连接。

（3）TCP的时延、瓶颈及存在的障碍？
最常见的TCP相关时延，其中包括：
* TCP连接建立握手；
* TCP慢启动拥塞控制；
* 数据聚集的Nagle算法；
* 用于捎带确认的TCP延迟确认算法；
* TIME_WAIT时延和端口耗尽。

（4）拥塞控制
所谓拥塞控制就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。
TCP的流量控制：利用滑动窗口实现流量控制。

