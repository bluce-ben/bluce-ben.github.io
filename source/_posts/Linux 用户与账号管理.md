---
title: Linux 用户与账号管理
date: 2018-01-22 18:25:29
categories:
- 书籍
- 《鸟哥的Linux私房菜基础篇（第三版）》
tags:
- 书籍
- Linux
---
Linux是个多用户多任务的分时操作系统，所有一个要使用系统资源的用户都必须先向系统管理员申请一个账号，然后以这个账号的身份进入系统。用户的账号一方面能帮助系统管理员对使用系统的用户进行跟踪，并控制他们对系统资源的访问；另一方面也能帮助用户组织文件，并为用户提供安全性保护。每个用户账号都拥有一个惟一的用户名和用户口令。用户在登录时键入正确的用户名和口令后，才能进入系统和自己的主目录。

实现用户账号的管理，要完成的工作主要有如下几个方面：
a.用户账号的管理。
b.用户口令的管理。
c.用户组的管理。
d.用户切换
<!--more-->
#### 用户账号的管理：添加、删除和修改：
##### 1、新增用户：useradd
```
[root@www ~]# useradd [-u UID] [-g 初始群组] [-G 次要群组] [-mM]\
> [-c 说明栏] [-d 家目录绝对路径] [-s shell] 使用者账号名
选项与参数：
    -u ：后面接的是 UID ，是一组数字。直接指定一个特定的 UID 给这个账号；
    -g ：后面接的那个组名就是用户所属的用户组。该群组的 GID 会被放置到 /etc/passwd 的第四个字段内。
    -G ：后面接的组名则是这个账号还可以加入的群组，即附加组。这个选项与参数会修改 /etc/group 内的相关资料！
    -M ：强制！不要建立用户家目录！(系统账号默认值)
    -m ：强制！要建立用户家目录！(一般账号默认值)
    -c ：这个就是 /etc/passwd 的第五栏的说明内容(comment)！可以随便我们设定
    -d ：指定某个目录成为家目录，而不要使用默认值。务必使用绝对路径！如果此目录不存在，则同时使用-m选项，能创建主目录。
    -s ：后面接一个 shell ，若没有指定则预设是 /bin/bash
    -r ：建立一个系统的账号，这个账号的 UID 会有限制 (参考 /etc/login.defs)
    -e ：后面接一个日期，格式为【YYYY-MM-DD】此项目可写入 shadow 第八字段，亦即账号失效日的设定项目；
    -f ：后面接 shadow 的第七字段项目，指定密码是否会失效。0 为立刻失效，-1 为永远不失效(密码只会过期而强制于登入时重新设定而已。)
```
范例一：完全参考默认值建立一个用户，名称为 ben
```
[root@www ~]# useradd ben
[root@www ~]# ll -d /home/ben
drwx------ 4 ben ben 4096 Feb 25 09:38 /home/ben
# 默认会建立用户家目录，且权限为 700 ！这是重点！
[root@www ~]# grep ben /etc/passwd /etc/shadow /etc/group
/etc/passwd:ben:x:504:505::/home/ben:/bin/bash
/etc/shadow:ben:!!:14300:0:99999:7:::
/etc/group:ben:x:505: <==预设会建立一个与账号一模一样的群组名
```
其实系统已经帮我们规定好非常多的默认值了，所以我们可以简单的使用【 useradd 账号 】来建立使用者即可。CentOS 这些默认值主要会帮我们处理几个项目：
* 在 /etc/passwd 里面建立一行与账号相关的数据，包括建立 UID/GID/ 家目录等；
* 在 /etc/shadow 里面将此账号的密码相关参数填入，但是尚未有密码；
* 在 /etc/group 里面加入一个与账号名称一模一样的组名；
* 在 /home 底下建立一个与账号同名的目录作为用户家目录，且权限为 700

由于在 /etc/shadow 内仅会有密码参数而不会有加密过的密码数据，因此我们在建立使用者账号时，还需要使用【 passwd 账号 】来给予密码才算是完成了用户建立的流程。


##### 2、删除用户：userdel
这个功能就太简单了，目的在删除用户的相关数据，而用户的数据有：
* 用户账号/密码相关参数：/etc/passwd, /etc/shadow
* 使用者群组相关参数：/etc/group, /etc/gshadow
* 用户个人档案数据： /home/username, /var/spool/mail/username..

整个指令的语法非常简单：
```
[root@www ~]# userdel [-r] username
选项与参数：
    -r ：连同用户的家目录也一起删除
```
范例一：删除 ben ，连同家目录一起删除
`[root@www ~]# userdel -r ben`

这个指令下达的时候要小心了！通常我们要移除一个账号的时候，你可以手动的将 /etc/passwd 与 /etc/shadow 里头的该账号取消即可！一般而言，如果该账号只是【暂时不启用】的话，那么将 /etc/shadow 里头账号失效日期 (第八字段) 设定为 0 就可以让该账号无法使用，但是所有跟该账号相关的数据都会留下来！使用 userdel 的时机通常是【你真的确定不要让该用户在主机上面使用任何数据了！】


##### 3、修改用户：usermod
（注：usermod 就是用来微调 useradd 增加的使用者参数）
```
[root@www ~]# usermod [-cdegGlsuLU] username
选项与参数：
    -c ：后面接账号的说明，即 /etc/passwd 第五栏的说明栏，可以加入一些账号的说明。
    -d ：后面接账号的家目录，即修改 /etc/passwd 的第六栏；
    -e ：后面接日期，格式是 YYYY-MM-DD 也就是在 /etc/shadow 内的第八个字段数据！
    -f ：后面接天数，为 shadow 的第七字段。
    -g ：后面接初始群组，修改 /etc/passwd 的第四个字段，亦即是 GID 的字段！
    -G ：后面接次要群组，修改这个使用者能够支持的群组，修改的是 /etc/group ！
    -a ：与 -G 合用，可【增加次要群组的支持】而非【设定】！
    -l ：后面接账号名称。亦即是修改账号名称， /etc/passwd 的第一栏！
    -s ：后面接 Shell 的实际档案，例如 /bin/bash 或 /bin/csh 等等。
    -u ：后面接 UID 数字！即 /etc/passwd 第三栏的资料；
    -L ：暂时将用户的密码冻结，让他无法登入。其实仅改 /etc/shadow 的密码栏。
    -U ：将 /etc/shadow 密码栏的 ! 拿掉，解冻！
```

##### 4、相关用户功能：
finger：查阅用户相关的信息
```
[root@www ~]# finger [-s] username
选项与参数：
    -s ：仅列出用户的账号、全名、终端机代号与登入时间等等；
    -m ：列出与后面接的账号相同者，而不是利用部分比对 (包括全名部分)
```
id：查询某人或自己的相关 UID/GID 等信息
`[root@www ~]# id [username]`


#### 用户口令的管理：passwd
使用 useradd 建立了账号之后，在预设的情况下，该账号是暂时被封锁的，也就是说，该账号是无法登入的，你可以去瞧一瞧 /etc/shadow 内的第二个字段就知道了。那该如何是好？使用 passwd 设定密码之后就可使用了。
```
[root@www ~]# passwd [--sdtin] <==所有人均可使用来改自己的密码
[root@www ~]# passwd [-l] [-u] [--sdtin] [-S] \
> [-n 日数] [-x 日数] [-w 日数] [-i 日期] 账号 <==root 功能
选项与参数：
    --stdin ：可以透过来自前一个管线的数据，作为密码输入，对 shell script 有帮助！
    -l ：是 Lock 的意思，会将 /etc/shadow 第二栏最前面加上 ! 使密码失效；
    -u ：与 -l 相对，是 Unlock 的意思！
    -S ：列出密码相关参数，亦即 shadow 档案内的大部分信息。
    -n ：后面接天数，shadow 的第 4 字段，多久不可修改密码天数
    -x ：后面接天数，shadow 的第 5 字段，多久内必须要更动密码
    -w ：后面接天数，shadow 的第 6 字段，密码过期前的警告天数
    -i ：后面接【日期】，shadow 的第 7 字段，密码失效日期
```
理论上，你的密码最好符合如下要求：
* 密码不能与账号相同；
* 密码尽量不要选用字典里面会出现的字符串；
* 密码需要超过 8 个字符；
* 密码不要使用个人信息，如身份证、手机号码、其他电话号码等；
* 密码不要使用简单的关系式，如 1+1=2， Iamben 等；
* 密码尽量使用大小写字符、数字、特殊字符($,_,-等)的组合。


#### 用户组的管理：新增、删除与修改
每个用户都有一个用户组，系统能对一个用户组中的所有用户进行集中管理。不同Linux系统对用户组的规定有所不同，如Linux下的用户属于和他同名的用户组，这个用户组在创建用户时同时创建。用户组的管理涉及用户组的添加、删除和修改。组的增加、删除和修改实际上就对/etc/group文件的更新。
用户组（group）就是具有相同特征的用户（user）的集合体；比如有时我们要让多个用户具有相同的权限，比如查看、修改某一文件或执行某个命令，这时我们需要用户组，我们把用户都定义到同一用户组，我们通过修改文件或目录的权限，让用户组具有一定的操作权限，这样用户组下的用户对该文件或目录都具有相同的权限，这是我们通过定义组和修改文件的权限来实现的；

##### 1、新增群组：groupadd
```
[root@www ~]# groupadd [-g gid] [-r] 组名
选项与参数：
    -g ：后面接某个特定的 GID ，用来直接给予某个 GID
    -r ：建立系统群组！与 /etc/login.defs 内的 GID_MIN 有关。
```
范例一：新建一个群组，名称为 group1
```
[root@www ~]# groupadd group1
[root@www ~]# grep group1 /etc/group /etc/gshadow
/etc/group:group1:x:702:
/etc/gshadow:group1:!::
# 群组的 GID 也是会由 500 以上最大 GID+1 来决定！
```

##### 2、修改群组：groupmod
跟 usermod 类似的，这个指令仅是在进行 group 相关参数的修改而已。
```
[root@www ~]# groupmod [-g gid] [-n group_name] 群组名
选项与参数：
    -g ：修改既有的 GID 数字；
    -n ：修改既有的组名
```
范例一：将刚刚上个指令建立的 group1 名称改为 mygroup ， GID 为 201
```
[root@www ~]# groupmod -g 201 -n mygroup group1
[root@www ~]# grep mygroup /etc/group /etc/gshadow
/etc/group:mygroup:x:201:
/etc/gshadow:mygroup:!::
```

##### 3、删除群组：groupdel
`[root@www ~]# groupdel [groupname]`
范例一：将刚刚的 mygroup 删除！
`[root@www ~]# groupdel mygroup`
范例二：若要删除 ben1 这个群组的话？
```
[root@www ~]# groupdel ben1
groupdel: cannot remove user's primary group.
```

为什么 mygroup 可以删除，但是 ben1 就不能删除呢？原因很简单，【有某个账号 (/etc/passwd)的 initial group 使用该群组！】如果查阅一下，你会发现在 /etc/passwd 内的 vbird1 第四栏的 GID 就是 /etc/group 内的 ben1 那个群组的 GID ，所以，无法删除！否则 ben1 这个用户登入系统后，就会找不到 GID ，那可是会造成很大的麻烦！那么如果硬要要删除 ben1 这个群组呢？你【必须要确认 /etc/passwd 内的账号没有任何人使用该群组作为 initial group 】才行。你可以：
* 修改 ben1 的 GID ，或者是：
* 删除 ben1 这个使用者。


#### 用户的身份切换
在 Linux 系统当中要作身份的变换？这是为啥？可能有底下几个原因！
>**使用一般账号：系统平日操作的好习惯**
事实上，为了安全的缘故，一些老人家都会建议你，尽量以一般身份使用者来操作 Linux 的日常作业！等到需要设定系统环境时，才变换身份成为 root 来进行系统管理，相对比较安全！避免作错一些严重的指令，例如恐怖的【 rm -rf / 】(千万作不得！)
**用较低权限启动系统服务**
相对于系统安全，有的时候，我们必须要以某些系统账号来进行程序的执行。举例来说，Linux 主机上面的一套软件，名称为 apache ，我们可以额外建立一个名为 apache 的用户来启动 apache 软件，如此一来，如果这个程序被攻破，至少系统还不至于就损毁了！
**软件本身的限制**
在远古时代的 telnet 程序中，该程序默认是不许使用 root 的身份登入的，telnet 会判断登入者的 UID，若 UID 为 0 的话，那就直接拒绝登入了。所以，你只能使用一般使用者来登入 Linux 服务器。此外，ssh 也可以设定拒绝 root 登入！那如果你有系统设定需求该如何是好？就变换身份！

由于上述考虑，所以我们都是使用一般账号登入系统的，等有需要进行系统维护或软件更新时才转为 root 的身份来动作。那如何让一般使用者转变身份成为 root 呢？主要有两种方式：
* 以【 su - 】直接将身份变成 root 即可，但是这个指令即需要 root 的密码，也就是说，如果你要以 su 变成 root 的话，你的一般使用者就必须要有 root 的密码才行；
* 以【 sudo 指令 】执行 root 的指令串，由于 sudo 需要事先设定妥当，且 sudo 需要输入用户自己的密码，因此多人共管同一部主机时，sudo 要比 su 来的好！至少 root 密码不会流出去！

##### 1、su
su 是最简单的身份切换指令了，他可以进行任何身份的切换！方法如下：
```
[root@www ~]# su [-lm] [-c 指令] [username]
选项与参数：
    - ：单纯使用 - 如【 su - 】代表使用 login-shell 的变量档案读取方式来登入系统；
    若使用者名称没有加上去，则代表切换为 root 的身份。
    -l ：与 - 类似，但后面需要加欲切换的使用者账号！也是 login-shell 的方式。
    -m ：-m 与 -p 是一样的，表示【使用目前的环境设定，而不读取新使用者的配置文件】
    -c ：仅进行一次指令，所以 -c 后面可以加上指令！
```

##### 2、sudo
相对于 su 需要了解新切换的用户密码 (常常是需要 root 的密码)，sudo 的执行则仅需要自己的密码即可！甚至可以设定不需要密码即可执行 sudo ！由于 sudo 可以让你以其他用户的身份执行指令 (通常是使用 root 的身份来执行指令)，因此并非所有人都能够执行 sudo ，而是仅有规范到 /etc/sudoers 内的用户才能够执行 sudo 这个指令！
```
[root@www ~]# sudo [-b] [-u 新使用者账号]
选项与参数：
    -b ：将后续的指令放到背景中让系统自行执行，而不与目前的 shell 产生影响
    -u ：后面可以接欲切换的使用者，若无此项则代表切换身份为 root 。
```
范例一：你想要以 sshd 的身份在 /tmp 底下建立一个名为 mysshd 的档案
```
[root@www ~]# sudo -u sshd touch /tmp/mysshd
[root@www ~]# ll /tmp/mysshd
-rw-r--r-- 1 sshd sshd 0 Feb 28 17:42 /tmp/mysshd
# 特别留意，这个档案的权限是由 sshd 所建立的情况！
```
范例二：你想要以 ben1 的身份建立 ~ben/www 并于其中建立 index.html档案
```
[root@www ~]# sudo -u ben1 sh -c "mkdir ~ben1/www; cd ben1/www; \
> echo 'This is index.html file' > index.html"
[root@www ~]# ll -a ~ben1/www
drwxr-xr-x 2 ben1 ben1 4096 Feb 28 17:51 .
drwx------ 5 ben1 ben1 4096 Feb 28 17:51 ..
-rw-r--r-- 1 ben1 ben1 24 Feb 28 17:51 index.html
# 要注意，建立者的身份是 ben1 ，且我们使用 sh -c "一串指令" 来执行的！
```
sudo 可以让你切换身份来进行某项任务，例如上面的两个范例。
>sudo 的执行是这样的流程：
1.当用户执行 sudo 时，系统于 /etc/sudoers 档案中搜寻该使用者是否有执行 sudo 的权限；
2.若使用者具有可执行 sudo 的权限后，便让使用者【输入用户自己的密码】来确认；
3.若密码输入成功，便开始进行 sudo 后续接的指令(但 root 执行 sudo 时，不需要输入密码)；
4.若欲切换的身份与执行者身份相同，那也不需要输入密码。

所以说，sudo 执行的重点是：【能否使用 sudo 必须要看 /etc/sudoers 的设定值，而可使用 sudo 者是透过输入用户自己的密码来执行后续的指令串】！由于能否使用与 /etc/sudoers 有关，所以我们当然要去编辑 sudoers 档案！不过，因为该档案的内容是有一定的规范的，因此直接使用 vi 去编辑是不好的。此时，我们得要透过 visudo 去修改这个档案！
（需要修改 /etc/sudoers 文件再查找......）