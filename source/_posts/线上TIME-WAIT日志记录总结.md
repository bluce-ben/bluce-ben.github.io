---
title: 线上TIME_WAIT日志记录总结
date: 2018-12-13 15:55:57
categories:
- [问题, 线上业务]
tags:
- 问题
---
首先发现的是平响太高了，之后又降下来了。然后，开始查询原因。下面是过程记录

刚开始是追寻的问题是： CLB的“心跳”突然没了？（注：CLB是负载均衡，心跳应该是CLB那边用来检测的。是一个文件。）
<!--more-->
查看php-fpm数量，发现有434个；最后群里有人说是他调的
![](/uploads/2018/12/network_timewait_001.jpg)
![](/uploads/2018/12/network_timewait_002.png)

然后就开始查询为啥“心跳”没了。
回答：CLB改心跳检查接口的话，如果改动比较大，应该是大面积报。最后问题回归到我们这边。

回答为啥将PHP-FPM数量调高？
我理解是这样的，后端有请求时间过长的接口，然后PHP-FPM都用于处理了这些请求长的接口，然后堵住了，然后导致后边的请求都在等待，包括心跳的。
心跳5s超时，前端CLB自己断的连接，报的499.
![](/uploads/2018/12/network_timewait_003.png)
所以，增加了fpm的进程数。

查看PHP的error。 只报进程数不够。突然频繁启动PHP进程，结果达到最大值了。
![](/uploads/2018/12/network_timewait_004.jpg)

*说明：在这个时间点，服务器内存和CPU也都没有问题。*

在监控记录中发现，5xx的记录有一个高峰。如下图：
![](/uploads/2018/12/network_timewait_005.jpg)
并且，报这么多错误，项目日志中并没有记录。（说明不是项目导致的问题）

然后有人在监控记录中有了新发现，如下图：
![](/uploads/2018/12/network_timewait_006.jpg)
![](/uploads/2018/12/network_timewait_007.jpg)

*注：在双十一期间，机器是10台。双十一前是2台（并且量不高）。双十一之后恢复到2台（量比以前高了点）。*

现在确定原因了，由于双十一之后量比以前增多了，导致 timewait 增多，2台机器的端口不能够满足那么大的连接。导致频频报5xx。

**解决方案：**
服务器降级，多开几台低配，降低 timewait。（注：timewait不可避免，只能通过增加机器，或者是调整服务端配置，提高timewait的回收速度。）
