---
title: Linux 防火墙的认识
date: 2018-01-17 18:45:06
categories:
- 书籍
- 《鸟哥的Linux私房菜服务器架设篇（第三版）》
tags:
- 书籍
- 网络安全
- iptables
---
#### 1、认识防火墙
网络安全除了随时注意相关软件的漏洞以及网络上的安全通报之外，你最好能够依据自己的环境来订定防火墙机制！这样对于你的网络环境，会比较有保障一点！那么什么是防火墙呢？其实防火墙就是透过订定一些有顺序的规则，并管制进入到我们网域内的主机 (或者可以说是网域) 数据封包的一种机制！更广义的来说，只要能够分析与过滤进出我们管理之网域的封包数据，就可以称为防火墙。

防火墙又可以分为硬件防火墙与本机的软件防火墙。硬件防火墙是由厂商设计好的主机硬件，这部硬件防火墙内的操作系统主要以提供封包数据的过滤机制为主，并将其他不必要的功能拿掉。因为单纯作为防火墙功能而已，因此封包过滤的效率较佳。至于软件防火墙呢？那就是我们主要研究的方向！软件防火墙本身就是在保护系统网络安全的一套软件(或称为机制)，例如 Netfilter 与 TCP Wrappers 都可以称为软件防火墙。
<!--more-->

#### 2、为何需要防火墙
封包进入本机时，会通过防火墙、服务器软件程序、SELinux 与文件系统等。所以基本上，如果你的系统 
* (1)已经关闭不需要而且危险的服务； 
* (2)已经将整个系统的所有软件都保持在最新的状态； 
* (3)权限设定妥当且定时进行备份工作； 
* (4)已经教育用户具有良好的网络、系统操作习惯。 

那么你的系统实际上已经颇为安全了！要不要架设防火墙？那就见仁见智了。

不过，毕竟网络世界是很复杂的，而 Linux 主机也不是一个简单的东西，说不定哪一天你在进行某个软件的测试时，主机突然间就启动了一个网络服务，如果你没有管制该服务的使用范围，那么该服务就等于对所有 Internet 开放，那就麻烦了！因为该服务可能可以允许任何人登入你的系统，那不是挺危险？

所以，防火墙能作什么呢？防火墙最大的功能就是帮助你【限制某些服务的存取来源】！举例来说： 
* (1)你可以限制文件传输服务 (FTP) 只在子域内的主机才能够使用，而不对整个 Internet 开放； 
* (2)你可以限制整部 Linux 主机仅可以接受客户端的 WWW 要求，其他的服务都关闭； 
* (3)你还可以限制整部主机仅能主动对外联机。

反过来说，若有客户端对我们主机发送主动联机的封包状态(TCP 封包的 SYN flag)就予以抵挡等等。这些就是最主要的防火墙功能了！

所以，防火墙最重要的任务就是在规划出：
1. 切割被信任(如子域)与不被信任(如 Internet)的网段；
2. 划分出可提供 Internet 的服务与必须受保护的服务；
3. 分析出可接受与不可接受的封包状态；

当然，咱们 Linux 的 iptables 防火墙软件还可以进行更细部深入的 NAT(Network Address Translation) 的设定，并进行更弹性的 IP 封包伪装功能，不过，对于单一主机的防火墙来说，最简单的任务还是上面那三项就是了！所以，你需不需要防火墙呢？理论上，当然需要！而且你必须要知道【你的系统哪些数据与服务需要保护】，针对需要受保护的服务来设定防火墙的规则吧！底下我们先来谈一谈，那在Linux 上头常见的防火墙类型有哪些？


#### 3、Linux 系统上防火墙的主要类别
基本上，依据防火墙管理的范围，我们可以将防火墙区分为网域型与单一主机型的控管。在单一主机型的控管方面，主要的防火墙有封包过滤型的 Netfilter 与依据服务软件程序作为分析的 TCP Wrappers 两种。若以区域型的防火墙而言，由于此类防火墙都是当作路由器角色，因此防火墙类型主要则有封包过滤的 Netfilter 与利用代理服务器 (proxy server) 进行存取代理的方式了。

##### （1）Netfilter (封包过滤机制)
所谓的封包过滤，亦即是分析进入主机的网络封包，将封包的表头数据捉出来进行分析，以决定该联机为放行或抵挡的机制。由于这种方式可以直接分析封包表头数据，所以包括硬件地址(MAC), 软件地址 (IP), TCP, UDP, ICMP 等封包的信息都可以进行过滤分析的功能，因此用途非常的广泛。(其实主要分析的是OSI 七层协议的 2, 3, 4 层)

在 Linux 上面我们使用核心内建的 Netfilter 这个机制，而 Netfilter 提供了 iptables 这个软件来作为防火墙封包过滤的指令。由于 Netfilter 是核心内建的功能，因此他的效率非常的高！非常适合于一般小型环境的设定！Netfilter 利用一些封包过滤的规则设定，来定义出什么资料可以接收，什么资料需要剔除，以达到保护主机的目的！

##### （2）TCP Wrappers (程序控管)
另一种抵挡封包进入的方法，为透过服务器程序的外挂 (tcpd) 来处置的！与封包过滤不同的是，这种机制主要是分析谁对某程序进行存取，然后透过规则去分析该服务器程序谁能够联机、谁不能联机。由于主要是透过分析服务器程序来控管，因此与启动的端口无关，只与程序的名称有关。举例来说，我们知道 FTP 可以启动在非正规的 port 21 进行监听，当你透过 Linux 内建的 TCP wrappers 限制 FTP 时，那么你只要知道 FTP 的软件名称 (vsftpd) ，然后对他作限制，则不管 FTP 启动在哪个端口，都会被该规则管理的。

##### （3）Proxy (代理服务器)
其实代理服务器是一种网络服务，它可以【代理】用户的需求，而代为前往服务器取得相关的资料。就有点像底下这个图示吧：
![](/uploads/2018/01/17/network_proxy.JPG 'Proxy Server 的运作原理简介')

以上图为例，当 Client 端想要前往 Internet 取得 Google 的数据时，他取得数据的流程是这样的：
>1.client 会向 proxy server 要求数据，请 proxy 帮忙处理；
>2.proxy 可以分析使用者的 IP 来源是否合法？使用者想要去的 Google 服务器是否合法？如果这个 client 的要求都合法的话，那么 proxy 就会主动的帮忙 client 前往 Google 取得资料；
>3.Google 所回传的数据是传给 proxy server 的，所以 Google 服务器上面看到的是 proxy server 的 IP；
>4.最后 proxy 将 Google 回传的数据送给 client。

这样了解了吗？没错，client 并没有直接连上 Internet ，所以在实线部分(步骤 1, 4)只要 Proxy 与 Client 可以联机就可以了！此时 client 甚至不需要拥有 public IP ！而当有人想要攻击 client 端的主机时，除非他能够攻破 Proxy server ，否则是无法与 client 联机的！
另外，一般 proxy 主机通常仅开放 port 80, 21, 20 等 WWW 与 FTP 的端口而已，而且通常 Proxy 就架设在路由器上面，因此可以完整的掌控局域网络内的对外联机！让你的 LAN 变的更安全啊！


#### 4、防火墙的使用限制
从前面的分析中，我们已经知道过封包滤式防火墙主要在分析 OSI 七层协议当中的 2, 3, 4 层，既然如此的话，Linux 的 Netfilter 机制到底可以做些什么事情呢？其实可以进行的分析工作主要有：
##### （1）拒绝让 Internet 的封包进入主机的某些端口
这个应该不难了解。例如你的 port 21 这个 FTP 相关的端口，若只想要开放给内部网络的话，那么当 Internet 来的封包想要进入你的 port 21 时，就可以将该数据封包丢掉！因为我们可以分析的到该封包表头的端口号码！
##### （2）拒绝让某些来源 IP 的封包进入
例如你已经发现某个 IP 主要都是来自攻击行为的主机，那么只要来自该 IP 的数据封包，就将他丢弃！这样也可以达到基础的安全！
##### （3）拒绝让带有某些特殊旗标 (flag) 的封包进入
最常拒绝的就是带有 SYN 的主动联机的旗标了！只要一经发现，你就可以将该封包丢弃！（因为都是一些攻击封包，占着茅坑不拉屎！）
##### （4）分析硬件地址 (MAC) 来决定联机与否
如果你的局域网络里面有比较捣蛋的但是又具有比较高强的网络功力的高手时，如果你使用 IP 来抵挡他使用网络的权限，而他却懂得反正换一个 IP 就好了，都在同一个网域内！同样还是在搞破坏！！怎么办？没关系，我们可以死锁他的网络卡硬件地址啊！因为 MAC 是焊在网络卡上面的，所以你只要分析到该使用者所使用的 MAC 之后，可以利用防火墙将该 MAC 锁住，除非他能够一换再换他的网络卡来取得新的 MAC，否则换 IP 是没有用的！

虽然 Netfilter 防火墙已经可以做到这么多的事情，不过，还是有很多事情没有办法透过 Netfilter 来完成！什么？设定防火墙之后还不安全啊！那当然啦！谁说设定了防火墙之后你的系统就一定安全？防火墙虽然可以防止不受欢迎的封包进入我们的网络当中，不过，某些情况下，他并不能保证我们的网络一定就很安全。举几个例子来谈一谈：
**（1）防火墙并不能很有效的抵挡病毒或木马程序**
假设你已经开放了 WWW 的服务，那么你的 WWW 主机上面，防火墙一定得要将 WWW 服务的 port 开放给 Client 端登入才行吧！否则你的 WWW 主机设定了等于没有用对吧！也就是说，只要进入你的主机的封包是要求 WWW 数据的，就可以通过你的防火墙。那好了，【万一你的 WWW 服务器软件有漏洞，或者本身向你要求 WWW 服务的该封包就是病毒在侦测你的系统】时，你的防火墙可是一点办法也没有啊！因为本来设定的规则就是会让他通过。
**（2）防火墙对于来自内部 LAN 的攻击较无承受力**
一般来说，我们对于 LAN 里面的主机都没有什么防火墙的设定，因为是我们自己的 LAN ，所以当然就设定为信任网域了！不过，LAN 里面总是可能有些网络小白，虽然他们不是故意要搞破坏，但是他们就是不懂！所以就乱用网络。这个时候就很糟糕，因为防火墙对于内部的规则设定通常比较少，所以就容易造成内部员工对于网络误用或滥用的情况。

所以，在你的 Linux 主机实地上网之前，还是得先：
* （1）关闭几个不安全的服务；
* （2）升级几个可能有问题的套件；
* （3）架设好最起码的安全防护--防火墙--