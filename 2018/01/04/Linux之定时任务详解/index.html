<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="书籍,Linux,Crontab," />





  <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml" />






<meta name="description" content="1、Linux 工作排程的种类： at, cron at ：at 是个可以处理仅执行一次就结束排程的指令，不过要执行 at 时，必须要有 atd 这个服务的支援才行。在某些新版的 distributions 中，atd 可能预设并没有启动，那么 at 这个指令就会失效！不过我们的 CentOS 预设是启动的。 crontab ：crontab 这个指令所设定的工作将会循环的一直进行下去！可循环的时">
<meta name="keywords" content="书籍,Linux,Crontab">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux之定时任务详解">
<meta property="og:url" content="http://yoursite.com/2018/01/04/Linux之定时任务详解/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="1、Linux 工作排程的种类： at, cron at ：at 是个可以处理仅执行一次就结束排程的指令，不过要执行 at 时，必须要有 atd 这个服务的支援才行。在某些新版的 distributions 中，atd 可能预设并没有启动，那么 at 这个指令就会失效！不过我们的 CentOS 预设是启动的。 crontab ：crontab 这个指令所设定的工作将会循环的一直进行下去！可循环的时">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/uploads/2018/01/linux_crontab_01.png">
<meta property="og:image" content="http://yoursite.com/uploads/2018/01/linux_crontab_02.png">
<meta property="og:updated_time" content="2018-01-18T07:01:55.911Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux之定时任务详解">
<meta name="twitter:description" content="1、Linux 工作排程的种类： at, cron at ：at 是个可以处理仅执行一次就结束排程的指令，不过要执行 at 时，必须要有 atd 这个服务的支援才行。在某些新版的 distributions 中，atd 可能预设并没有启动，那么 at 这个指令就会失效！不过我们的 CentOS 预设是启动的。 crontab ：crontab 这个指令所设定的工作将会循环的一直进行下去！可循环的时">
<meta name="twitter:image" content="http://yoursite.com/uploads/2018/01/linux_crontab_01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/04/Linux之定时任务详解/"/>





  <title>Linux之定时任务详解 | Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9c4b2184b7b2f90dbd8b8e34c44e11eb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/04/Linux之定时任务详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zheng Benwu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/IMG_2796.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Linux之定时任务详解</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T14:17:53+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/书籍/" itemprop="url" rel="index">
                    <span itemprop="name">书籍</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/书籍/《鸟哥的Linux私房菜基础篇（第三版）》/" itemprop="url" rel="index">
                    <span itemprop="name">《鸟哥的Linux私房菜基础篇（第三版）》</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/04/Linux之定时任务详解/" class="leancloud_visitors" data-flag-title="Linux之定时任务详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="1、Linux-工作排程的种类：-at-cron"><a href="#1、Linux-工作排程的种类：-at-cron" class="headerlink" title="1、Linux 工作排程的种类： at, cron"></a>1、Linux 工作排程的种类： at, cron</h3><ol>
<li>at ：at 是个可以处理仅执行一次就结束排程的指令，不过要执行 at 时，必须要有 atd 这个服务的支援才行。在某些新版的 distributions 中，atd 可能预设并没有启动，那么 at 这个指令就会失效！不过我们的 CentOS 预设是启动的。</li>
<li>crontab ：crontab 这个指令所设定的工作将会循环的一直进行下去！可循环的时间为分钟、小时、每周、每月或每年等。crontab 除了可以使用指令执行外，亦可编辑 /etc/crontab 来支持。至于让 crontab 可以生效的服务则是 crond 这个服务。<a id="more"></a>
</li>
</ol>
<h3 id="2、atd-的启动与-at-运作的方式"><a href="#2、atd-的启动与-at-运作的方式" class="headerlink" title="2、atd 的启动与 at 运作的方式"></a>2、atd 的启动与 at 运作的方式</h3><p>要使用单一工作排程时，我们的 Linux 系统上面必须要有负责这个排程的服务，那就是 atd ！不过并非所有的 Linux distributions 都预设会把他打开的，所以，某些时刻我们必须要手动将他启用才行。启用的方法很简单，就是这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# /etc/init.d/atd restart</span><br><span class="line">正在停止 atd: [ 确定 ]</span><br><span class="line">正在激活 atd: [ 确定 ]</span><br><span class="line"># 再设定一下开机时就启动这个服务，免得每次重新启动都得再来一次！</span><br><span class="line">[root@www ~]# chkconfig atd on</span><br></pre></td></tr></table></figure></p>
<h4 id="（1）at-的运作方式"><a href="#（1）at-的运作方式" class="headerlink" title="（1）at 的运作方式"></a>（1）at 的运作方式</h4><p>既然是工作排程，那么应该会有产生工作的方式，并且将这些工作排进行程表中！那么产生工作的方式是怎么进行的？事实上，我们使用 at 这个指令来产生所要运作的工作，并将这个工作以文本文件的方式写入 /var/spool/at/ 目录内，该工作便能等待 atd 这个服务的取用与执行了。就这么简单。<br>不过，并不是所有的人都可以进行 at 工作排程！为什么？因为安全的理由，很多主机被所谓的【绑架】后，最常发现的就是他们的系统当中多了很多的怪客程序 (cracker program)， 这些程序非常可能运用工作排程来执行或搜集系统信息，并定时的回报给怪客团体！所以，除非是你认可的账号，否则先不要让他们使用 at ！那怎么达到使用 at 的列管呢？<br>我们可以利用 /etc/at.allow 与 /etc/at.deny 这两个档案来进行 at 的使用限制！加上这两个档案后，at 的工作情况其实是这样的：</p>
<ol>
<li>先找寻 /etc/at.allow 这个档案，写在这个档案中的使用者才能使用 at ，没有在这个档案中的使用者则不能使用 at (即使没有写在 at.deny 当中)；</li>
<li>如果 /etc/at.allow 不存在，就寻找 /etc/at.deny 这个档案，若写在这个 at.deny 的使用者则不能使用at ，而没有在这个 at.deny 档案中的使用者，就可以使用 at ；</li>
<li>如果两个档案都不存在，那么只有 root 可以使用 at 这个指令。</li>
</ol>
<p>透过这个说明，我们知道 /etc/at.allow 是管理较为严格的方式，而 /etc/at.deny 则较为松散 (因为账号没有在该档案中，就能够执行 at 了)。在一般的 distributions 当中，由于假设系统上的所有用户都是可信任的，因此系统通常会保留一个空的 /etc/at.deny 档案，意思是允讲所有人使用 at 指令的意思 (您可以自行检查一下该档案)。不过，万一你不希望有某些使用者使用 at 的话，将那个使用者的账号写入 /etc/at.deny 即可！一个账号写一行。</p>
<h4 id="（2）实际运作单一工作排程"><a href="#（2）实际运作单一工作排程" class="headerlink" title="（2）实际运作单一工作排程"></a>（2）实际运作单一工作排程</h4><p>基本的语法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# at [-mldv] TIME</span><br><span class="line">[root@www ~]# at -c 工作号码</span><br><span class="line">选项与参数：</span><br><span class="line">-m ：当 at 的工作完成后，即使没有输出讯息，亦以 email 通知使用者该工作已完成。</span><br><span class="line">-l ：at -l 相当于 atq，列出目前系统上面的所有该用户的 at 排程；</span><br><span class="line">-d ：at -d 相当于 atrm ，可以取消一个在 at 排程中的工作；</span><br><span class="line">-v ：可以使用较明显的时间格式栏出 at 排程中的任务栏表；</span><br><span class="line">-c ：可以列出后面接的该项工作的实际指令内容。</span><br><span class="line">TIME：时间格式，这里可以定义出【什么时候要进行 at 这项工作】的时间，格式有：</span><br><span class="line">HH:MM ex&gt; 04:00</span><br><span class="line">在今日的 HH:MM 时刻进行，若该时刻已超过，则明天的 HH:MM 进行此工作。</span><br><span class="line">HH:MM YYYY-MM-DD ex&gt; 04:00 2009-03-17</span><br><span class="line">强制规定在某年某月的某一天的特殊时刻进行该工作！</span><br><span class="line">HH:MM[am|pm] [Month] [Date] ex&gt; 04pm March 17</span><br><span class="line">也是一样，强制在某年某月某日的某时刻进行！</span><br><span class="line">HH:MM[am|pm] + number [minutes|hours|days|weeks]</span><br><span class="line">ex&gt; now + 5 minutes ex&gt; 04pm + 3 days</span><br><span class="line">就是说，在某个时间点【再加几个时间后】才进行。</span><br></pre></td></tr></table></figure></p>
<p>老实说，这个 at 指令的下达最重要的地方在于【时间】的指定了！一般使用【 now + … 】的方式来定义现在过多少时间再进行工作，但有时也需要定义特定的时间点来进行！底下的范例先看看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">范例一：再过五分钟后，将 /root/.bashrc 寄给 root 自己</span><br><span class="line">[root@www ~]# at now + 5 minutes &lt;==记得单位要加 s</span><br><span class="line">at&gt; /bin/mail root -s &quot;testing at job&quot; &lt; /root/.bashrc</span><br><span class="line">at&gt; &lt;EOT&gt; &lt;==这里输入 [ctrl] + d 就会出现 &lt;EOF&gt; 的字样！代表结束！</span><br><span class="line">job 4 at 2009-03-14 15:38</span><br><span class="line"># 上面这行信息在说明，第 4 个 at 工作将在 2009/03/14 的 15:38 进行！</span><br><span class="line"># 而执行 at 会进入所谓的 at shell 环境，让你下达多重指令等待运作！</span><br><span class="line">范例二：将上述的第 4 项工作内容列出来查阅</span><br><span class="line">[root@www ~]# at -c 4</span><br><span class="line">#!/bin/sh &lt;==就是透过 bash shell </span><br><span class="line"># atrun uid=0 gid=0</span><br><span class="line"># mail root 0</span><br><span class="line">umask 22</span><br><span class="line">....(中间省略许多的环境变量项目)....</span><br><span class="line">cd /root || &#123; &lt;==可以看出，会到下达 at 时的工作目录去执行指令</span><br><span class="line">echo &apos;Execution directory inaccessible&apos; &gt;&amp;2</span><br><span class="line">exit 1</span><br><span class="line">&#125;</span><br><span class="line">/bin/mail root -s &quot;testing at job&quot; &lt; /root/.bashrc</span><br><span class="line"># 你可以看到指令执行的目录 (/root)，还有多个环境变量与实际的指令内容</span><br><span class="line">范例三：由于机房预计于 2009/03/18 停电，我想要在 2009/03/17 23:00 关机？</span><br><span class="line">[root@www ~]# at 23:00 2009-03-17</span><br><span class="line">at&gt; /bin/sync</span><br><span class="line">at&gt; /bin/sync</span><br><span class="line">at&gt; /sbin/shutdown -h now</span><br><span class="line">at&gt; &lt;EOT&gt;</span><br><span class="line">job 5 at 2009-03-17 23:00</span><br><span class="line"># at 还可以在一个工作内输入多个指令</span><br></pre></td></tr></table></figure></p>
<p>事实上，当我们使用 at 时会进入一个 at shell 的环境来让用户下达工作指令，此时，建议你最好使用绝对路径来下达你的指令，比较不会有问题！由于指令的下达与 PATH 变量有关，同时与当时的工作目录也有关连(如果有牵涉到档案的话)，因此使用绝对路径来下达指令，会是比较一劳永逸的方法。</p>
<p>at 有另外一个很棒的优点，那就是【背景执行】的功能！由于 at 工作排程的使用上，系统会将该项 at 工作独立出你的 bash 环境中，直接交给系统的 atd 程序来接管，因此，当你下达了 at 的工作之后就可以立刻脱机了，剩下的工作就完全交给 Linux 管理即可！所以，如果有长时间的网络工作时，使用 at 可以让你免除网络断线后的困扰！</p>
<h3 id="3、循环执行的例行性工作排程"><a href="#3、循环执行的例行性工作排程" class="headerlink" title="3、循环执行的例行性工作排程"></a>3、循环执行的例行性工作排程</h3><p>相对于 at 是仅执行一次的工作，循环执行的例行性工作排程则是由 cron (crond) 这个系统服务来控制的。刚刚谈过 Linux 系统上面原本就有非常多的例行性工作，因此这个系统服务是默认启动的。另外，由于使用者自己也可以进行例行性工作排程，所以，Linux 也提供使用者控制例行性工作排程的指令(crontab)。底下我们分别来聊一聊：</p>
<h4 id="（1）使用者的设定"><a href="#（1）使用者的设定" class="headerlink" title="（1）使用者的设定"></a>（1）使用者的设定</h4><p>使用者想要建立循环型工作排程时，使用的是 crontab 这个指令。不过，为了安全性的问题，与 at 同样的，我们可以限制使用 crontab 的使用者账号！使用的限制数据有：</p>
<ul>
<li>/etc/cron.allow：将可以使用 crontab 的账号写入其中，若不在这个档案内的使用者则不可使用 crontab；</li>
<li>/etc/cron.deny：将不可以使用 crontab 的账号写入其中，若未记录到这个档案当中的使用者，就可以使用crontab 。</li>
</ul>
<p>与 at 很像。同样的，以优先级来说，/etc/cron.allow 比 /etc/cron.deny 要优先，而判断上面，这两个档案只选择一个来限制而已，因此，建议你只要保留一个即可，免得影响自己在设定上面的判断！一般来说，系统默认是保留 /etc/cron.deny，你可以将不想让他执行 crontab 的那个使用者写入 /etc/cron.deny 当中，一个账号一行！</p>
<p>当用户使用 crontab 这个指令来建立工作排程之后，该项工作就会被记录到 /var/spool/cron/ 里面去，而且是以账号来作为判别的。举例来说，dmtsai 使用 crontab 后，他的工作会被记录到 /var/spool/cron/dmtsai 里头去！但请注意，不要使用 vi 直接编辑该档案，因为可能由于输入语法错误，会导致无法执行 cron 。另外，cron 执行的每一项工作都会被记录到 /var/log/cron 这个登录档中，所以，如果你的 Linux 不知道有否被植入木马时，也可以搜寻一下 /var/log/cron 这个登录档！</p>
<h4 id="（2）crontab-的语法："><a href="#（2）crontab-的语法：" class="headerlink" title="（2）crontab 的语法："></a>（2）crontab 的语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# crontab [-u username] [-l|-e|-r]</span><br><span class="line">选项与参数：</span><br><span class="line">-u ：只有 root 才能进行这个任务，亦即帮其他使用者建立/移除 crontab 工作排程；</span><br><span class="line">-e ：编辑 crontab 的工作内容</span><br><span class="line">-l ：查阅 crontab 的工作内容</span><br><span class="line">-r ：移除所有的 crontab 的工作内容，若仅要移除一项，请用 -e 去编辑。</span><br><span class="line">范例一：用 dmtsai 的身份在每天的 12:00 发信给自己</span><br><span class="line">[dmtsai@www ~]$ crontab -e</span><br><span class="line"># 此时会进入 vi 的编辑画面让您编辑工作！注意到，每项工作都是一行。</span><br><span class="line">0 12 * * * mail dmtsai -s &quot;at 12:00&quot; &lt; /home/dmtsai/.bashrc</span><br><span class="line">#分 时 日 月 周 |&lt;==============指令串========================&gt;|</span><br></pre></td></tr></table></figure>
<p>预设情况下，任何使用者只要不被列入 /etc/cron.deny 当中，那么他就可以直接下达【 crontab -e 】去编辑自己的例行性命令。整个过程就如同上面提到的，会进入 vi 的编辑画面，然后以一个工作一行来编辑，编辑完毕之后输入【 :wq 】储存后离开 vi 就可以了。而每项工作 (每行) 的格式都是具有六个字段，这六个字段的意义为：<br><img src="/uploads/2018/01/linux_crontab_01.png" alt=""><br>比较有趣的是那个【周】，周的数字为 0 或 7 时，都代表【星期天】的意思！另外，还有一些辅助的字符，大概有底下这些：<br><img src="/uploads/2018/01/linux_crontab_02.png" alt=""><br><strong>（注：那个 crontab 每个人都只有一个档案存在，就是在 /var/spool/cron 里面！还有建议：【指令下达时，最好使用绝对路径，这样比较不会找不到执行档。】）</strong></p>
<h4 id="（3）系统的配置文件：-etc-crontab"><a href="#（3）系统的配置文件：-etc-crontab" class="headerlink" title="（3）系统的配置文件： /etc/crontab"></a>（3）系统的配置文件： /etc/crontab</h4><p>如果是【系统的例行性任务】时，你只要编辑 /etc/crontab 这个档案就可以。有一点需要特别注意！那就是 crontab -e 这个 crontab 其实是 /usr/bin/crontab 这个执行档，但是 /etc/crontab 可是一个【纯文本档】。你可以 root 的身份编辑一下这个档案。<br>基本上， cron 这个服务的最低侦测限制是【分钟】，所以【 cron 会每分钟去读取一次 /etc/crontab 与 /var/spool/cron 里面的数据内容 】，因此，只要你编辑完 /etc/crontab 这个档案，并且将他储存之后，那么 cron 的设定就自动的会来执行了。</p>
<p>下面是 /etc/crontab 的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# cat /etc/crontab</span><br><span class="line">SHELL=/bin/bash 	&lt;==使用哪种 shell 接口</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin 	&lt;==执行文件搜寻路径</span><br><span class="line">MAILTO=root 	&lt;==若有额外STDOUT，以 email 将数据送给谁</span><br><span class="line">HOME=/ 	&lt;==默认此 shell 的家目录所在</span><br><span class="line"># run-parts</span><br><span class="line">01 * * * * root run-parts /etc/cron.hourly &lt;==每小时</span><br><span class="line">02 4 * * * root run-parts /etc/cron.daily &lt;==每天</span><br><span class="line">22 4 * * 0 root run-parts /etc/cron.weekly &lt;==每周日</span><br><span class="line">42 4 1 * * root run-parts /etc/cron.monthly &lt;==每个月 1 号</span><br><span class="line">分 时 日 月 周 执行者身份 指令串</span><br></pre></td></tr></table></figure></p>
<p>看到这个档案的内容你大概就了解了吧。这个档案与将刚刚我们下达 crontab -e 的内容几乎完全一模一样！只是有几个地方不太相同：</p>
<blockquote>
<p><strong>MAILTO=root：</strong><br>    这个项目是说，当 /etc/crontab 这个档案中的例行性工作的指令发生错误时，或者是该工作的执行结果有 STDOUT/STDERR 时，会将错误讯息或者是屏幕显示的讯息传给谁？默认当然是由系统直接寄发一封 mail 给 root。不过，由于 root 并无法在客户端中以 POP3 之类的软件收信，因此，通常都将这个 e-mail 改成自己的账号，好随时了解系统的状况！例如：MAILTO=dmtsai@my.host.name<br><strong>PATH=….：</strong><br>    在 BASH 当中一直提到的执行文件路径问题。这里就是输入执行文件的搜寻路径！使用默认的路径设定就已经很足够了。<br><strong>01 <em> </em> <em> </em> root run-parts /etc/cron.hourly：</strong><br>    这个 /etc/crontab 里面默认定义出四项工作任务，分别是每小时、每天、每周及每个月分别进行一次的工作！但是在五个字段后面接的并不是挃令，而是一个新的字段，那就是【执行后面那串指令的身份】为何。这不使用者的 crontab -e 不相同。由于使用者自己的 crontab 并不需要指定身份，但 /etc/crontab 里面当然要指定身份。以上表的内容来说，系统默认的例行性工作是以 root 的身份来进行的。<br>    那么后面那串指令是什么呢？你可以使用【 which run-parts 】搜寻看看，其实那是一个 bash script！如果你直接进入 /usr/bin/run-parts 去看看，会发现这支指令会将后面接的【目录】内的所有档案捉出来执行！这也就是说【如果你想让系统每小时主动帮你执行某个指令，将该指令写成 script，并将该档案放置到 /etc/cron.hourly/ 目录下即可】的意思。<br>    现在你知道系统是如何进行他默认的一堆例行性工作排程了吗？如果你下达【 ll /etc/cron.daily 】就可以看到一堆档案，那些档案就是系统提供的 script ，而这堆 scripts 将会在每天的凌晨 4:02 开始运作！这也是为啥如果你是夜猫族，就会发现奇怪的是，Linux 系统为何早上 4:02 开始会很忙碌的发出一些硬盘跑动的声音！因为他必须要进行 makewhatis,pdatedb, rpm rebuild 等等的任务。</p>
</blockquote>
<p>由于 CentOS 提供的 run-parts 这个 script 的辅助，因此 /etc/crontab 这个档案里面支持两种下达指令的方式，一种是直接下达指令，一种则是以目录来规划，例如：</p>
<blockquote>
<p><strong>指令型态</strong><br><code>01 * * * * dmtsai mail -s &quot;testing&quot; kiki &lt; /home/dmtsai/test.txt</code><br>以 dmtsai 这个使用者的身份，在每小时执行一次 mail 指令。<br><strong>目录规划</strong><br><code>*/5 * * * * root run-parts /root/runcron</code><br>建立一个 /root/runcron 的目录，将要每隔五分钟执行的【可执行文件】都写到该目录下，就可以让系统每五分钟执行一次该目录下的所有可执行文件。</p>
</blockquote>
<h3 id="4、一些注意事项："><a href="#4、一些注意事项：" class="headerlink" title="4、一些注意事项："></a>4、一些注意事项：</h3><h4 id="（1）资源分配不均的问题"><a href="#（1）资源分配不均的问题" class="headerlink" title="（1）资源分配不均的问题"></a>（1）资源分配不均的问题</h4><p>如果每个流程都在同一个时间启动的话，那么在某个时段时，我的系统会变的相当的繁忙，所以，这个时候就必须要分别设定。我可以这样做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# vi /etc/crontab</span><br><span class="line">1,6,11,16,21,26,31,36,41,46,51,56 * * * * root CMD1</span><br><span class="line">2,7,12,17,22,27,32,37,42,47,52,57 * * * * root CMD2</span><br><span class="line">3,8,13,18,23,28,33,38,43,48,53,58 * * * * root CMD3</span><br><span class="line">4,9,14,19,24,29,34,39,44,49,54,59 * * * * root CMD4</span><br></pre></td></tr></table></figure></p>
<p>看到了没？那个【 , 】分隔的时候，请注意，不要有空格符！（连续的意思）如此一来，则可以将每五分钟工作的流程分别在不同的时刻来工作！则可以让系统的执行较为顺畅！</p>
<h4 id="（2）取消不要的输出项目"><a href="#（2）取消不要的输出项目" class="headerlink" title="（2）取消不要的输出项目"></a>（2）取消不要的输出项目</h4><p>另外一个困扰发生在【 当有执行成果或者是执行的项目中有输出的数据时，该数据将会 mail 给 MAILTO 设定的账号 】，那么当有一个排程一直出错（例如 DNS 的侦测系统当中，若 DNS 上层主机挂掉，那么你就会一直收到错误讯息！）怎么办？可以使用数据流重导向直接以【命令重导向】将输出的结果输出到 /dev/null 这个垃圾桶当中就好了！</p>
<h4 id="（3）安全的检验"><a href="#（3）安全的检验" class="headerlink" title="（3）安全的检验"></a>（3）安全的检验</h4><p>很多时候被植入木马都是以例行命令的方式植入的，所以可以藉由检查 /var/log/cron 的内容来视察是否有【非您设定的 cron 被执行了？】这个时候就需要小心一点！</p>
<h4 id="（4）周与日月不可同时并存"><a href="#（4）周与日月不可同时并存" class="headerlink" title="（4）周与日月不可同时并存"></a>（4）周与日月不可同时并存</h4><p>另一个需要注意的地方在于：【你可以分别以周或者是日月为单位作为循环，但你不可使用「几月几号且为星期几」的模式工作】。这个意思是说，你不可以这样编写一个工作排程：<br>    30 12 11 9 5 root echo “just test” &lt;==这是错诨癿写法<br>本来你以为九月十一号且为星期五才会进行这项工作，无奈的是，系统可能会判定每个星期五作一次，或每年的 9 月 11 号分别进行，如此一来与你当初的规划就不一样了。所以，得要注意这个地方！上述的写法是不对的！</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/书籍/" rel="tag"># 书籍</a>
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/Crontab/" rel="tag"># Crontab</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/03/认识与学习BASH之Shell-Scripts/" rel="next" title="认识与学习BASH之Shell Scripts">
                <i class="fa fa-chevron-left"></i> 认识与学习BASH之Shell Scripts
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/10/基础网络概念（一）/" rel="prev" title="基础网络概念（一）">
                基础网络概念（一） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/IMG_2796.JPG"
                alt="Zheng Benwu" />
            
              <p class="site-author-name" itemprop="name">Zheng Benwu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/bluce-ben" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:zheng_benwu@163.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、Linux-工作排程的种类：-at-cron"><span class="nav-number">1.</span> <span class="nav-text"><a href="#1&#x3001;Linux-&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;&#x7684;&#x79CD;&#x7C7B;&#xFF1A;-at-cron" class="headerlink" title="1&#x3001;Linux &#x5DE5;&#x4F5C;&#x6392;&#x7A0B;&#x7684;&#x79CD;&#x7C7B;&#xFF1A; at, cron"></a>1&#x3001;Linux &#x5DE5;&#x4F5C;&#x6392;&#x7A0B;&#x7684;&#x79CD;&#x7C7B;&#xFF1A; at, cron</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、atd-的启动与-at-运作的方式"><span class="nav-number">2.</span> <span class="nav-text"><a href="#2&#x3001;atd-&#x7684;&#x542F;&#x52A8;&#x4E0E;-at-&#x8FD0;&#x4F5C;&#x7684;&#x65B9;&#x5F0F;" class="headerlink" title="2&#x3001;atd &#x7684;&#x542F;&#x52A8;&#x4E0E; at &#x8FD0;&#x4F5C;&#x7684;&#x65B9;&#x5F0F;"></a>2&#x3001;atd &#x7684;&#x542F;&#x52A8;&#x4E0E; at &#x8FD0;&#x4F5C;&#x7684;&#x65B9;&#x5F0F;</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）at-的运作方式"><span class="nav-number">2.1.</span> <span class="nav-text"><a href="#&#xFF08;1&#xFF09;at-&#x7684;&#x8FD0;&#x4F5C;&#x65B9;&#x5F0F;" class="headerlink" title="&#xFF08;1&#xFF09;at &#x7684;&#x8FD0;&#x4F5C;&#x65B9;&#x5F0F;"></a>&#xFF08;1&#xFF09;at &#x7684;&#x8FD0;&#x4F5C;&#x65B9;&#x5F0F;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）实际运作单一工作排程"><span class="nav-number">2.2.</span> <span class="nav-text"><a href="#&#xFF08;2&#xFF09;&#x5B9E;&#x9645;&#x8FD0;&#x4F5C;&#x5355;&#x4E00;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;" class="headerlink" title="&#xFF08;2&#xFF09;&#x5B9E;&#x9645;&#x8FD0;&#x4F5C;&#x5355;&#x4E00;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;"></a>&#xFF08;2&#xFF09;&#x5B9E;&#x9645;&#x8FD0;&#x4F5C;&#x5355;&#x4E00;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、循环执行的例行性工作排程"><span class="nav-number">3.</span> <span class="nav-text"><a href="#3&#x3001;&#x5FAA;&#x73AF;&#x6267;&#x884C;&#x7684;&#x4F8B;&#x884C;&#x6027;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;" class="headerlink" title="3&#x3001;&#x5FAA;&#x73AF;&#x6267;&#x884C;&#x7684;&#x4F8B;&#x884C;&#x6027;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;"></a>3&#x3001;&#x5FAA;&#x73AF;&#x6267;&#x884C;&#x7684;&#x4F8B;&#x884C;&#x6027;&#x5DE5;&#x4F5C;&#x6392;&#x7A0B;</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）使用者的设定"><span class="nav-number">3.1.</span> <span class="nav-text"><a href="#&#xFF08;1&#xFF09;&#x4F7F;&#x7528;&#x8005;&#x7684;&#x8BBE;&#x5B9A;" class="headerlink" title="&#xFF08;1&#xFF09;&#x4F7F;&#x7528;&#x8005;&#x7684;&#x8BBE;&#x5B9A;"></a>&#xFF08;1&#xFF09;&#x4F7F;&#x7528;&#x8005;&#x7684;&#x8BBE;&#x5B9A;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）crontab-的语法："><span class="nav-number">3.2.</span> <span class="nav-text"><a href="#&#xFF08;2&#xFF09;crontab-&#x7684;&#x8BED;&#x6CD5;&#xFF1A;" class="headerlink" title="&#xFF08;2&#xFF09;crontab &#x7684;&#x8BED;&#x6CD5;&#xFF1A;"></a>&#xFF08;2&#xFF09;crontab &#x7684;&#x8BED;&#x6CD5;&#xFF1A;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）系统的配置文件：-etc-crontab"><span class="nav-number">3.3.</span> <span class="nav-text"><a href="#&#xFF08;3&#xFF09;&#x7CFB;&#x7EDF;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF1A;-etc-crontab" class="headerlink" title="&#xFF08;3&#xFF09;&#x7CFB;&#x7EDF;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF1A; /etc/crontab"></a>&#xFF08;3&#xFF09;&#x7CFB;&#x7EDF;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF1A; /etc/crontab</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、一些注意事项："><span class="nav-number">4.</span> <span class="nav-text"><a href="#4&#x3001;&#x4E00;&#x4E9B;&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#xFF1A;" class="headerlink" title="4&#x3001;&#x4E00;&#x4E9B;&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#xFF1A;"></a>4&#x3001;&#x4E00;&#x4E9B;&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#xFF1A;</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）资源分配不均的问题"><span class="nav-number">4.1.</span> <span class="nav-text"><a href="#&#xFF08;1&#xFF09;&#x8D44;&#x6E90;&#x5206;&#x914D;&#x4E0D;&#x5747;&#x7684;&#x95EE;&#x9898;" class="headerlink" title="&#xFF08;1&#xFF09;&#x8D44;&#x6E90;&#x5206;&#x914D;&#x4E0D;&#x5747;&#x7684;&#x95EE;&#x9898;"></a>&#xFF08;1&#xFF09;&#x8D44;&#x6E90;&#x5206;&#x914D;&#x4E0D;&#x5747;&#x7684;&#x95EE;&#x9898;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）取消不要的输出项目"><span class="nav-number">4.2.</span> <span class="nav-text"><a href="#&#xFF08;2&#xFF09;&#x53D6;&#x6D88;&#x4E0D;&#x8981;&#x7684;&#x8F93;&#x51FA;&#x9879;&#x76EE;" class="headerlink" title="&#xFF08;2&#xFF09;&#x53D6;&#x6D88;&#x4E0D;&#x8981;&#x7684;&#x8F93;&#x51FA;&#x9879;&#x76EE;"></a>&#xFF08;2&#xFF09;&#x53D6;&#x6D88;&#x4E0D;&#x8981;&#x7684;&#x8F93;&#x51FA;&#x9879;&#x76EE;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）安全的检验"><span class="nav-number">4.3.</span> <span class="nav-text"><a href="#&#xFF08;3&#xFF09;&#x5B89;&#x5168;&#x7684;&#x68C0;&#x9A8C;" class="headerlink" title="&#xFF08;3&#xFF09;&#x5B89;&#x5168;&#x7684;&#x68C0;&#x9A8C;"></a>&#xFF08;3&#xFF09;&#x5B89;&#x5168;&#x7684;&#x68C0;&#x9A8C;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（4）周与日月不可同时并存"><span class="nav-number">4.4.</span> <span class="nav-text"><a href="#&#xFF08;4&#xFF09;&#x5468;&#x4E0E;&#x65E5;&#x6708;&#x4E0D;&#x53EF;&#x540C;&#x65F6;&#x5E76;&#x5B58;" class="headerlink" title="&#xFF08;4&#xFF09;&#x5468;&#x4E0E;&#x65E5;&#x6708;&#x4E0D;&#x53EF;&#x540C;&#x65F6;&#x5E76;&#x5B58;"></a>&#xFF08;4&#xFF09;&#x5468;&#x4E0E;&#x65E5;&#x6708;&#x4E0D;&#x53EF;&#x540C;&#x65F6;&#x5E76;&#x5B58;</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zheng Benwu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0xNn1pwwQEUyuYJA5FwnLGKm-gzGzoHsz", "hYKQqspX8ivguvgDs3vgDhmC");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
